"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Link = require('found/lib/Link');
const first = require("lodash/first");
const last = require("lodash/last");
const React = require("react");
const Relay = require('react-relay');
const { createFragmentContainer, graphql } = Relay;
const CascadedColumnsList_1 = require("./CascadedColumnsList");
const Video_1 = require("./Video");
require("../../../src/components/VideoList/style.pcss");
var SortField;
(function (SortField) {
    SortField["TheOwl"] = "score";
    SortField["PercentChange"] = "percent";
    SortField["ChangeCount"] = "change";
})(SortField || (SortField = {}));
var SortDirection;
(function (SortDirection) {
    SortDirection["Ascending"] = "asc";
    SortDirection["Descending"] = "desc";
})(SortDirection || (SortDirection = {}));
class VideoList extends React.Component {
    constructor(props) {
        super(props);
    }
    render() {
        const { sorted } = this;
        const percents = sorted.map(vid => vid.percent);
        let chartScale = Math.max(0, ...percents) / 100 + 1;
        if (chartScale < 2)
            chartScale = 2;
        const snapshotCounts = sorted.map(vid => {
            return vid.video.snapshots.length;
        });
        const maxSnapshotCount = Math.max(0, ...snapshotCounts);
        const videos = sorted.map(vid => {
            return (React.createElement(Video_1.default, { key: vid.video.id, id: `video-${vid.video.id}`, video: vid.video, chartScale: chartScale, chartDataPountCount: maxSnapshotCount }));
        });
        return (React.createElement("section", { className: "video-list", ref: ref => this.el = ref },
            React.createElement("nav", null,
                React.createElement("h1", null, "Order:"),
                React.createElement("ul", null, this.sortLinks)),
            React.createElement(CascadedColumnsList_1.default, null, videos)));
    }
    get getParams() {
        const { search } = this.props.location;
        if (!search || search.length === 1)
            return {};
        return search
            .slice(1)
            .split('&')
            .reduce((accl, pair) => {
            const [key, value] = pair.split('=').map(decodeURIComponent);
            accl[key] = value;
            return accl;
        }, {});
    }
    get sort() {
        let { sortField: field, sortDirection: direction } = this.getParams;
        const fields = Object.keys(SortField).map(key => {
            return SortField[key];
        });
        const directions = Object.keys(SortDirection).map(key => {
            return SortDirection[key];
        });
        if (!field || fields.indexOf(field) === -1)
            field = SortField.TheOwl;
        if (!direction || directions.indexOf(direction) === -1)
            direction = SortDirection.Descending;
        return { field: field, direction: direction };
    }
    get sortLinks() {
        const sorts = {
            [SortField.TheOwl]: 'As the Owl Flies',
            [SortField.ChangeCount]: 'Count',
            [SortField.PercentChange]: 'Percent',
        };
        return Object.keys(sorts).map(field => {
            const isActive = field === this.sort.field;
            const classes = [];
            if (isActive)
                classes.push('active');
            const sortDirection = isActive && this.sort.direction === SortDirection.Descending
                ? SortDirection.Ascending : SortDirection.Descending;
            classes.push(sortDirection);
            const params = { sortField: field, sortDirection };
            const search = Object.keys(params).map(key => {
                return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
            });
            return (React.createElement("li", { key: field, className: classes.join(' ') },
                React.createElement(Link, { to: {
                        pathname: this.props.location.pathname,
                        search: '?' + search.join('&')
                    } }, sorts[field])));
        });
    }
    get scored() {
        return this.props.activeVideos.map(vid => {
            const start = first(vid.snapshots);
            const end = last(vid.snapshots);
            const startCount = start != null
                ? [start.views, start.likes, start.dislikes, start.favorites,
                    start.comments]
                    .map(Number).reduce((sum, num) => sum + num, 0)
                : 0;
            const endCount = end != null
                ? [end.views, end.likes, end.dislikes, end.favorites, end.comments]
                    .map(Number).reduce((sum, num) => sum + num, 0)
                : 0;
            const change = endCount - startCount;
            const ratio = (endCount / startCount) || 0;
            return {
                video: vid,
                score: change * Math.pow((ratio - 1), 2),
                percent: (ratio * 100) - 100,
                change,
            };
        });
    }
    get sorted() {
        return this.scored.sort((vid1, vid2) => {
            const { field, direction } = this.sort;
            const [a, b] = direction === SortDirection.Descending
                ? [vid2, vid1] : [vid1, vid2];
            // Field values can be NaN. Prevents items without stats sorting weirdly.
            return (a[field] || 0) - (b[field] || 0);
        });
    }
}
exports.default = createFragmentContainer(VideoList, graphql `
	fragment VideoList_activeVideos on Video @relay(plural: true) {
		id
    snapshots: statsByAge(seconds: $statsAge) {
      views
      likes
      dislikes
      favorites
      comments
    }
		...Video_video
	}
`);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVmlkZW9MaXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVmlkZW9MaXN0LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBQ3RDLHNDQUFzQztBQUN0QyxvQ0FBb0M7QUFDcEMsK0JBQThCO0FBQzlCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUNwQyxNQUFNLEVBQUUsdUJBQXVCLEVBQUUsT0FBTyxFQUFFLEdBQUcsS0FBSyxDQUFBO0FBRWxELCtEQUF1RDtBQUN2RCxtQ0FBMkM7QUFFM0Msd0RBQXFEO0FBT3JELElBQUssU0FJSjtBQUpELFdBQUssU0FBUztJQUNiLDZCQUFnQixDQUFBO0lBQ2hCLHNDQUF5QixDQUFBO0lBQ3pCLG1DQUFzQixDQUFBO0FBQ3ZCLENBQUMsRUFKSSxTQUFTLEtBQVQsU0FBUyxRQUliO0FBRUQsSUFBSyxhQUdKO0FBSEQsV0FBSyxhQUFhO0lBQ2pCLGtDQUFpQixDQUFBO0lBQ2pCLG9DQUFtQixDQUFBO0FBQ3BCLENBQUMsRUFISSxhQUFhLEtBQWIsYUFBYSxRQUdqQjtBQWlCRCxlQUFnQixTQUFRLEtBQUssQ0FBQyxTQUF1QjtJQUlwRCxZQUFZLEtBQUs7UUFDaEIsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ2IsQ0FBQztJQUVELE1BQU07UUFDTCxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFBO1FBRXZCLE1BQU0sUUFBUSxHQUFhLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUN6RCxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUE7UUFDbkQsRUFBRSxDQUFDLENB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RUFBRSxPQUFPLENBQUE7Ozs7Ozs7Ozs7OztDQVl4RCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJcbmNvbnN0IExpbmsgPSByZXF1aXJlKCdmb3VuZC9saWIvTGluaycpXG5pbXBvcnQgZmlyc3QgPSByZXF1aXJlKCdsb2Rhc2gvZmlyc3QnKVxuaW1wb3J0IGxhc3QgPSByZXF1aXJlKCdsb2Rhc2gvbGFzdCcpXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCdcbmNvbnN0IFJlbGF5ID0gcmVxdWlyZSgncmVhY3QtcmVsYXknKVxuY29uc3QgeyBjcmVhdGVGcmFnbWVudENvbnRhaW5lciwgZ3JhcGhxbCB9ID0gUmVsYXlcblxuaW1wb3J0IENhc2NhZGVkQ29sdW1uc0xpc3QgZnJvbSAnLi9DYXNjYWRlZENvbHVtbnNMaXN0J1xuaW1wb3J0IFZpZGVvLCB7IFZpZGVvUHJvcHMgfSBmcm9tICcuL1ZpZGVvJ1xuXG5pbXBvcnQgJy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZpZGVvTGlzdC9zdHlsZS5wY3NzJ1xuXG5cbmludGVyZmFjZSBWaWRlb1Byb3BzMiBleHRlbmRzIFZpZGVvUHJvcHMge1xuXHRpZCxcbn1cblxuZW51bSBTb3J0RmllbGQge1xuXHRUaGVPd2wgPSAnc2NvcmUnLFxuXHRQZXJjZW50Q2hhbmdlID0gJ3BlcmNlbnQnLFxuXHRDaGFuZ2VDb3VudCA9ICdjaGFuZ2UnLFxufVxuXG5lbnVtIFNvcnREaXJlY3Rpb24ge1xuXHRBc2NlbmRpbmcgPSAnYXNjJyxcblx0RGVzY2VuZGluZyA9ICdkZXNjJyxcbn1cblxuaW50ZXJmYWNlIFByb3BzIHtcblx0YWN0aXZlVmlkZW9zOiBWaWRlb1Byb3BzMltdXG5cdGxvY2F0aW9uOiB7XG5cdFx0YWN0aW9uOiBzdHJpbmcsXG5cdFx0ZGVsdGE/OiBudW1iZXIsXG5cdFx0aGFzaDogc3RyaW5nLFxuXHRcdGluZGV4PzogbnVtYmVyLFxuXHRcdGtleT86IHN0cmluZyxcblx0XHRwYXRobmFtZTogc3RyaW5nLFxuXHRcdHNlYXJjaDogc3RyaW5nLFxuXHR9XG59XG5cbmludGVyZmFjZSBTdGF0ZSB7fVxuXG5jbGFzcyBWaWRlb0xpc3QgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XG5cblx0cHJpdmF0ZSBlbDogSFRNTEVsZW1lbnR8bnVsbFxuXG5cdGNvbnN0cnVjdG9yKHByb3BzKSB7XG5cdFx0c3VwZXIocHJvcHMpXG5cdH1cblxuXHRyZW5kZXIoKSB7XG5cdFx0Y29uc3QgeyBzb3J0ZWQgfSA9IHRoaXNcblxuXHRcdGNvbnN0IHBlcmNlbnRzOiBudW1iZXJbXSA9IHNvcnRlZC5tYXAodmlkID0+IHZpZC5wZXJjZW50KVxuXHRcdGxldCBjaGFydFNjYWxlID0gTWF0aC5tYXgoMCwgLi4ucGVyY2VudHMpIC8gMTAwICsgMVxuXHRcdGlmIChjaGFydFNjYWxlIDwgMilcblx0XHRcdGNoYXJ0U2NhbGUgPSAyXG5cblx0XHRjb25zdCBzbmFwc2hvdENvdW50cyA9IHNvcnRlZC5tYXAodmlkID0+IHtcblx0XHRcdHJldHVybiB2aWQudmlkZW8uc25hcHNob3RzLmxlbmd0aFxuXHRcdH0pXG5cdFx0Y29uc3QgbWF4U25hcHNob3RDb3VudCA9IE1hdGgubWF4KDAsIC4uLnNuYXBzaG90Q291bnRzKVxuXG5cdFx0Y29uc3QgdmlkZW9zID0gc29ydGVkLm1hcCh2aWQgPT4geyByZXR1cm4gKFxuXHRcdFx0PFZpZGVvIGtleT17dmlkLnZpZGVvLmlkfSBpZD17YHZpZGVvLSR7dmlkLnZpZGVvLmlkfWB9XG5cdFx0XHRcdFx0XHQgdmlkZW89e3ZpZC52aWRlb31cblx0XHRcdFx0XHRcdCBjaGFydFNjYWxlPXtjaGFydFNjYWxlfVxuXHRcdFx0XHRcdFx0IGNoYXJ0RGF0YVBvdW50Q291bnQ9e21heFNuYXBzaG90Q291bnR9IC8+XG5cdFx0KSB9KVxuXG5cdFx0cmV0dXJuIChcblx0XHRcdDxzZWN0aW9uIGNsYXNzTmFtZT1cInZpZGVvLWxpc3RcIiByZWY9e3JlZiA9PiB0aGlzLmVsID0gcmVmfT5cblx0XHRcdFx0PG5hdj5cblx0XHRcdFx0XHQ8aDE+T3JkZXI6PC9oMT5cblx0XHRcdFx0XHQ8dWw+XG5cdFx0XHRcdFx0XHR7dGhpcy5zb3J0TGlua3N9XG5cdFx0XHRcdFx0PC91bD5cblx0XHRcdFx0PC9uYXY+XG5cdFx0XHRcdDxDYXNjYWRlZENvbHVtbnNMaXN0PlxuXHRcdFx0XHRcdHt2aWRlb3N9XG5cdFx0XHRcdDwvQ2FzY2FkZWRDb2x1bW5zTGlzdD5cblx0XHRcdDwvc2VjdGlvbj5cblx0XHQpXG5cdH1cblxuXHRwcml2YXRlIGdldCBnZXRQYXJhbXMoKToge1trZXk6IHN0cmluZ106IHN0cmluZ30ge1xuXHRcdGNvbnN0IHsgc2VhcmNoIH0gPSB0aGlzLnByb3BzLmxvY2F0aW9uXG5cblx0XHRpZiAoIXNlYXJjaCB8fCBzZWFyY2gubGVuZ3RoID09PSAxKVxuXHRcdFx0cmV0dXJuIHt9XG5cblx0XHRyZXR1cm4gc2VhcmNoXG5cdFx0XHQuc2xpY2UoMSlcblx0XHRcdC5zcGxpdCgnJicpXG5cdFx0XHQucmVkdWNlKChhY2NsLCBwYWlyKSA9PiB7XG5cdFx0XHRcdGNvbnN0IFtrZXksIHZhbHVlXSA9IHBhaXIuc3BsaXQoJz0nKS5tYXAoZGVjb2RlVVJJQ29tcG9uZW50KVxuXHRcdFx0XHRhY2NsW2tleV0gPSB2YWx1ZVxuXHRcdFx0XHRyZXR1cm4gYWNjbFxuXHRcdFx0fSwge30pXG5cdH1cblxuXHRwcml2YXRlIGdldCBzb3J0KCk6IHsgZmllbGQ6IFNvcnRGaWVsZCwgZGlyZWN0aW9uOiBTb3J0RGlyZWN0aW9uIH0ge1xuXHRcdGxldCB7IHNvcnRGaWVsZDogZmllbGQsIHNvcnREaXJlY3Rpb246IGRpcmVjdGlvbiB9ID0gdGhpcy5nZXRQYXJhbXNcblxuXHRcdGNvbnN0IGZpZWxkcyA9IE9iamVjdC5rZXlzKFNvcnRGaWVsZCkubWFwKGtleSA9PiB7XG5cdFx0XHRyZXR1cm4gU29ydEZpZWxkW2tleV1cblx0XHR9KVxuXHRcdGNvbnN0IGRpcmVjdGlvbnMgPSBPYmplY3Qua2V5cyhTb3J0RGlyZWN0aW9uKS5tYXAoa2V5ID0+IHtcblx0XHRcdHJldHVybiBTb3J0RGlyZWN0aW9uW2tleV1cblx0XHR9KVxuXG5cdFx0aWYgKCFmaWVsZCB8fCBmaWVsZHMuaW5kZXhPZihmaWVsZCkgPT09IC0xKVxuXHRcdFx0ZmllbGQgPSBTb3J0RmllbGQuVGhlT3dsXG5cdFx0aWYgKCFkaXJlY3Rpb24gfHwgZGlyZWN0aW9ucy5pbmRleE9mKGRpcmVjdGlvbikgPT09IC0xKVxuXHRcdFx0ZGlyZWN0aW9uID0gU29ydERpcmVjdGlvbi5EZXNjZW5kaW5nXG5cblx0XHRyZXR1cm4geyBmaWVsZDogZmllbGQgYXMgU29ydEZpZWxkLCBkaXJlY3Rpb246IGRpcmVjdGlvbiBhcyBTb3J0RGlyZWN0aW9uIH1cblx0fVxuXG5cdHByaXZhdGUgZ2V0IHNvcnRMaW5rcygpIHtcblx0XHRjb25zdCBzb3J0cyA9IHtcblx0XHRcdFtTb3J0RmllbGQuVGhlT3dsXTogJ0FzIHRoZSBPd2wgRmxpZXMnLFxuXHRcdFx0W1NvcnRGaWVsZC5DaGFuZ2VDb3VudF06ICdDb3VudCcsXG5cdFx0XHRbU29ydEZpZWxkLlBlcmNlbnRDaGFuZ2VdOiAnUGVyY2VudCcsXG5cdFx0fVxuXG5cdFx0cmV0dXJuIE9iamVjdC5rZXlzKHNvcnRzKS5tYXAoZmllbGQgPT4ge1xuXHRcdFx0Y29uc3QgaXNBY3RpdmUgPSBmaWVsZCA9PT0gdGhpcy5zb3J0LmZpZWxkXG5cdFx0XHRjb25zdCBjbGFzc2VzOiBzdHJpbmdbXSA9IFtdXG5cblx0XHRcdGlmIChpc0FjdGl2ZSlcblx0XHRcdFx0Y2xhc3Nlcy5wdXNoKCdhY3RpdmUnKVxuXG5cdFx0XHRjb25zdCBzb3J0RGlyZWN0aW9uID1cblx0XHRcdFx0aXNBY3RpdmUgJiYgdGhpcy5zb3J0LmRpcmVjdGlvbiA9PT0gU29ydERpcmVjdGlvbi5EZXNjZW5kaW5nXG5cdFx0XHRcdD8gU29ydERpcmVjdGlvbi5Bc2NlbmRpbmcgOiBTb3J0RGlyZWN0aW9uLkRlc2NlbmRpbmdcblx0XHRcdGNsYXNzZXMucHVzaChzb3J0RGlyZWN0aW9uKVxuXG5cdFx0XHRjb25zdCBwYXJhbXMgPSB7IHNvcnRGaWVsZDogZmllbGQsIHNvcnREaXJlY3Rpb24gfVxuXHRcdFx0Y29uc3Qgc2VhcmNoID0gT2JqZWN0LmtleXMocGFyYW1zKS5tYXAoa2V5ID0+IHtcblx0XHRcdFx0cmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHBhcmFtc1trZXldKVxuXHRcdFx0fSlcblxuXHRcdFx0cmV0dXJuIChcblx0XHRcdFx0PGxpIGtleT17ZmllbGR9IGNsYXNzTmFtZT17Y2xhc3Nlcy5qb2luKCcgJyl9PlxuXHRcdFx0XHRcdDxMaW5rIHRvPXt7XG5cdFx0XHRcdFx0XHRwYXRobmFtZTogdGhpcy5wcm9wcy5sb2NhdGlvbi5wYXRobmFtZSxcblx0XHRcdFx0XHRcdHNlYXJjaDogJz8nICsgc2VhcmNoLmpvaW4oJyYnKVxuXHRcdFx0XHRcdH19PlxuXHRcdFx0XHRcdFx0e3NvcnRzW2ZpZWxkXX1cblx0XHRcdFx0XHQ8L0xpbms+XG5cdFx0XHRcdDwvbGk+XG5cdFx0XHQpXG5cdFx0fSlcblx0fVxuXG5cdHByaXZhdGUgZ2V0IHNjb3JlZCgpIHtcblx0XHRyZXR1cm4gdGhpcy5wcm9wcy5hY3RpdmVWaWRlb3MubWFwKHZpZCA9PiB7XG5cdFx0XHRjb25zdCBzdGFydCA9IGZpcnN0KHZpZC5zbmFwc2hvdHMpXG5cdFx0XHRjb25zdCBlbmQgID0gbGFzdCh2aWQuc25hcHNob3RzKVxuXG5cdFx0XHRjb25zdCBzdGFydENvdW50ID0gc3RhcnQgIT0gbnVsbFxuXHRcdFx0XHQ/IFtzdGFydC52aWV3cywgc3RhcnQubGlrZXMsIHN0YXJ0LmRpc2xpa2VzLCBzdGFydC5mYXZvcml0ZXMsXG5cdFx0XHRcdFx0c3RhcnQuY29tbWVudHNdXG5cdFx0XHRcdFx0Lm1hcChOdW1iZXIpLnJlZHVjZSgoc3VtLCBudW0pID0+IHN1bSArIG51bSwgMClcblx0XHRcdFx0OiAwXG5cdFx0XHRjb25zdCBlbmRDb3VudCA9IGVuZCAhPSBudWxsXG5cdFx0XHRcdD8gW2VuZC52aWV3cywgZW5kLmxpa2VzLCBlbmQuZGlzbGlrZXMsIGVuZC5mYXZvcml0ZXMsIGVuZC5jb21tZW50c11cblx0XHRcdFx0XHQubWFwKE51bWJlcikucmVkdWNlKChzdW0sIG51bSkgPT4gc3VtICsgbnVtLCAwKVxuXHRcdFx0XHQ6IDBcblxuXHRcdFx0Y29uc3QgY2hhbmdlICA9IGVuZENvdW50IC0gc3RhcnRDb3VudFxuXHRcdFx0Y29uc3QgcmF0aW8gICA9IChlbmRDb3VudCAvIHN0YXJ0Q291bnQpIHx8IDBcblxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0dmlkZW86IHZpZCxcblx0XHRcdFx0c2NvcmU6IGNoYW5nZSAqIChyYXRpby0xKSoqMixcblx0XHRcdFx0cGVyY2VudDogKHJhdGlvICogMTAwKSAtIDEwMCxcblx0XHRcdFx0Y2hhbmdlLFxuXHRcdFx0fVxuXHRcdH0pXG5cdH1cblxuXHRwcml2YXRlIGdldCBzb3J0ZWQoKSB7XG5cdFx0cmV0dXJuIHRoaXMuc2NvcmVkLnNvcnQoKHZpZDEsIHZpZDIpID0+IHtcblx0XHRcdGNvbnN0IHsgZmllbGQsIGRpcmVjdGlvbiB9ID0gdGhpcy5zb3J0XG5cblx0XHRcdGNvbnN0IFthLCBiXSA9IGRpcmVjdGlvbiA9PT0gU29ydERpcmVjdGlvbi5EZXNjZW5kaW5nXG5cdFx0XHRcdD8gW3ZpZDIsIHZpZDFdIDogW3ZpZDEsIHZpZDJdXG5cblx0XHRcdC8vIEZpZWxkIHZhbHVlcyBjYW4gYmUgTmFOLiBQcmV2ZW50cyBpdGVtcyB3aXRob3V0IHN0YXRzIHNvcnRpbmcgd2VpcmRseS5cblx0XHRcdHJldHVybiAoYVtmaWVsZF0gfHwgMCkgLSAoYltmaWVsZF0gfHwgMClcblx0XHR9KVxuXHR9XG5cbn1cblxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVGcmFnbWVudENvbnRhaW5lcihWaWRlb0xpc3QsIGdyYXBocWxgXG5cdGZyYWdtZW50IFZpZGVvTGlzdF9hY3RpdmVWaWRlb3Mgb24gVmlkZW8gQHJlbGF5KHBsdXJhbDogdHJ1ZSkge1xuXHRcdGlkXG4gICAgc25hcHNob3RzOiBzdGF0c0J5QWdlKHNlY29uZHM6ICRzdGF0c0FnZSkge1xuICAgICAgdmlld3NcbiAgICAgIGxpa2VzXG4gICAgICBkaXNsaWtlc1xuICAgICAgZmF2b3JpdGVzXG4gICAgICBjb21tZW50c1xuICAgIH1cblx0XHQuLi5WaWRlb192aWRlb1xuXHR9XG5gKVxuIl19