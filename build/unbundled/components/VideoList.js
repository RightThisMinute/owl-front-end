"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Link = require('found/lib/Link');
const first = require("lodash/first");
const last = require("lodash/last");
const React = require("react");
const Relay = require('react-relay');
const { createFragmentContainer, graphql } = Relay;
const Video_1 = require("./Video");
require("../../../src/components/VideoList/style.pcss");
var SortField;
(function (SortField) {
    SortField["TheOwl"] = "score";
    SortField["PercentChange"] = "percent";
    SortField["ChangeCount"] = "change";
})(SortField || (SortField = {}));
var SortDirection;
(function (SortDirection) {
    SortDirection["Ascending"] = "asc";
    SortDirection["Descending"] = "desc";
})(SortDirection || (SortDirection = {}));
class VideoList extends React.Component {
    constructor(props) {
        super(props);
        this.state = {
            videoOffsets: {}
        };
    }
    componentWillReceiveProps(nextProps) {
        const { search: nextSearch } = nextProps.location;
        const { search } = this.props.location;
        if (search !== nextSearch)
            this.setState({
                videoOffsets: {}
            });
    }
    componentDidMount() {
        console.debug('did mount');
        this.scoochItems();
    }
    componentDidUpdate() {
        console.debug('did update');
        if (Object.keys(this.state.videoOffsets).length === 0)
            this.scoochItems();
    }
    render() {
        const { sorted } = this;
        const percents = sorted.map(vid => vid.percent);
        let chartScale = Math.max(0, ...percents) / 100 + 1;
        if (chartScale < 2)
            chartScale = 2;
        const snapshotCounts = sorted.map(vid => {
            return vid.video.snapshots.length;
        });
        const maxSnapshotCount = Math.max(0, ...snapshotCounts);
        const videos = sorted.map(vid => {
            let style = {};
            const offset = this.state.videoOffsets[vid.video.id];
            if (offset)
                style.transform = `translateY(${offset}px)`;
            const id = `video-${vid.video.id}`;
            return (React.createElement(Video_1.default, { key: vid.video.id, id: id, video: vid.video, style: style, chartScale: chartScale, chartDataPountCount: maxSnapshotCount }));
        });
        return (React.createElement("section", { className: "video-list", ref: ref => this.el = ref },
            React.createElement("nav", null,
                React.createElement("h1", null, "Order:"),
                React.createElement("ul", null, this.sortLinks)),
            React.createElement("div", { className: "items" }, videos)));
    }
    get getParams() {
        const { search } = this.props.location;
        if (!search || search.length === 1)
            return {};
        return search
            .slice(1)
            .split('&')
            .reduce((accl, pair) => {
            const [key, value] = pair.split('=').map(decodeURIComponent);
            accl[key] = value;
            return accl;
        }, {});
    }
    get sort() {
        let { sortField: field, sortDirection: direction } = this.getParams;
        const fields = Object.keys(SortField).map(key => {
            return SortField[key];
        });
        const directions = Object.keys(SortDirection).map(key => {
            return SortDirection[key];
        });
        if (!field || fields.indexOf(field) === -1)
            field = SortField.TheOwl;
        if (!direction || directions.indexOf(direction) === -1)
            direction = SortDirection.Descending;
        return { field: field, direction: direction };
    }
    get sortLinks() {
        const sorts = {
            [SortField.TheOwl]: 'As the Owl Flies',
            [SortField.ChangeCount]: 'Count',
            [SortField.PercentChange]: 'Percent',
        };
        return Object.keys(sorts).map(field => {
            const isActive = field === this.sort.field;
            const classes = [];
            if (isActive)
                classes.push('active');
            const sortDirection = isActive && this.sort.direction === SortDirection.Descending
                ? SortDirection.Ascending : SortDirection.Descending;
            classes.push(sortDirection);
            const params = { sortField: field, sortDirection };
            const search = Object.keys(params).map(key => {
                return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
            });
            return (React.createElement("li", { key: field, className: classes.join(' ') },
                React.createElement(Link, { to: {
                        pathname: this.props.location.pathname,
                        search: '?' + search.join('&')
                    } }, sorts[field])));
        });
    }
    get scored() {
        return this.props.activeVideos.map(vid => {
            const start = first(vid.snapshots);
            const end = last(vid.snapshots);
            const startCount = start != null
                ? [start.views, start.likes, start.dislikes, start.favorites,
                    start.comments]
                    .map(Number).reduce((sum, num) => sum + num, 0)
                : 0;
            const endCount = end != null
                ? [end.views, end.likes, end.dislikes, end.favorites, end.comments]
                    .map(Number).reduce((sum, num) => sum + num, 0)
                : 0;
            const change = endCount - startCount;
            const ratio = (endCount / startCount) || 0;
            return {
                video: vid,
                score: change * Math.pow((ratio - 1), 2),
                percent: (ratio * 100) - 100,
                change,
            };
        });
    }
    get sorted() {
        return this.scored.sort((vid1, vid2) => {
            const { field, direction } = this.sort;
            const [a, b] = direction === SortDirection.Descending
                ? [vid2, vid1] : [vid1, vid2];
            // Field values can be NaN. Prevents items without stats sorting weirdly.
            return (a[field] || 0) - (b[field] || 0);
        });
    }
    scoochItems() {
        console.debug('scooching');
        if (!this.el)
            return;
        const itemElements = this.el.querySelectorAll(':scope > .items > *');
        const items = [];
        itemElements.forEach(el => {
            let { top, height } = el.getBoundingClientRect();
            const styles = window.getComputedStyle(el);
            height += (parseInt(styles.marginTop || '0', 10) || 0)
                + (parseInt(styles.marginBottom || '0', 10) || 0);
            items.push({ el, top, height });
        });
        let prevCol;
        const columns = items.reduce((columns, item, index) => {
            let col;
            if (columns.length === 0)
                col = 0;
            else if (columns.length === index) {
                // Potentially need to add another column.
                const prevItem = last(columns[prevCol]);
                if (item.top === prevItem.top)
                    col = columns.length;
            }
            if (col === undefined)
                col = index % columns.length;
            if (!columns[col])
                columns[col] = [];
            columns[col].push(item);
            prevCol = col;
            return columns;
        }, []);
        const videoOffsets = {};
        columns.forEach((items) => {
            let prevOffset = 0;
            items.forEach((item, index, list) => {
                const id = item.el.getAttribute('id');
                if (id === null)
                    return;
                const key = id.replace(/^video-/, '');
                if (index === 0) {
                    videoOffsets[key] = 0;
                    return;
                }
                const prevItem = list[index - 1];
                const y = prevItem.top + prevOffset + prevItem.height;
                videoOffsets[key] = prevOffset = y - item.top;
            });
        });
        this.setState({ videoOffsets });
    }
}
exports.default = createFragmentContainer(VideoList, graphql `
	fragment VideoList_activeVideos on Video @relay(plural: true) {
		id
    snapshots: statsByAge(seconds: $statsAge) {
      views
      likes
      dislikes
      favorites
      comments
    }
		...Video_video
	}
`);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVmlkZW9MaXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVmlkZW9MaXN0LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBQ3RDLHNDQUFzQztBQUN0QyxvQ0FBb0M7QUFDcEMsK0JBQThCO0FBQzlCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUNwQyxNQUFNLEVBQUUsdUJBQXVCLEVBQUUsT0FBTyxFQUFFLEdBQUcsS0FBSyxDQUFBO0FBRWxELG1DQUEyQztBQUUzQyx3REFBcUQ7QUFPckQsSUFBSyxTQUlKO0FBSkQsV0FBSyxTQUFTO0lBQ2IsNkJBQWdCLENBQUE7SUFDaEIsc0NBQXlCLENBQUE7SUFDekIsbUNBQXNCLENBQUE7QUFDdkIsQ0FBQyxFQUpJLFNBQVMsS0FBVCxTQUFTLFFBSWI7QUFFRCxJQUFLLGFBR0o7QUFIRCxXQUFLLGFBQWE7SUFDakIsa0NBQWlCLENBQUE7SUFDakIsb0NBQW1CLENBQUE7QUFDcEIsQ0FBQyxFQUhJLGFBQWEsS0FBYixhQUFhLFFBR2pCO0FBbUJELGVBQWdCLFNBQVEsS0FBSyxDQUFDLFNBQXVCO0lBSXBELFlBQVksS0FBSztRQUNoQixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDWixJQUFJLENBQUMsS0FBSyxHQUFHO1lBQ1osWUFBWSxFQUFFLEVBQUU7U0FDaEIsQ0FBQTtJQUNGLENBQUM7SUFFRCx5QkFBeUIsQ0FBQyxTQUFnQjtRQUN6QyxNQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUE7UUFDakQsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFBO1FBRXRDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxVQUFVLENBQUM7WUFDekIs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LEtBQUssR0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDOUIsTUFBTSxDQUFDLEdBQUcsUUFBUSxDQUFDLEdBQUcsR0FBRyxVQUFVLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQTtnQkFDckQsWUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFVBQVUsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtZQUM5QyxDQUFDLENBQUMsQ0FBQTtRQUNILENBQUMsQ0FBQyxDQUFBO1FBRUYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUE7SUFDaEMsQ0FBQztDQUVEO0FBR0Qsa0JBQWUsdUJBQXVCLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQTs7Ozs7Ozs7Ozs7O0NBWXhELENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxuY29uc3QgTGluayA9IHJlcXVpcmUoJ2ZvdW5kL2xpYi9MaW5rJylcbmltcG9ydCBmaXJzdCA9IHJlcXVpcmUoJ2xvZGFzaC9maXJzdCcpXG5pbXBvcnQgbGFzdCA9IHJlcXVpcmUoJ2xvZGFzaC9sYXN0JylcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0J1xuY29uc3QgUmVsYXkgPSByZXF1aXJlKCdyZWFjdC1yZWxheScpXG5jb25zdCB7IGNyZWF0ZUZyYWdtZW50Q29udGFpbmVyLCBncmFwaHFsIH0gPSBSZWxheVxuXG5pbXBvcnQgVmlkZW8sIHsgVmlkZW9Qcm9wcyB9IGZyb20gJy4vVmlkZW8nXG5cbmltcG9ydCAnLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVmlkZW9MaXN0L3N0eWxlLnBjc3MnXG5cblxuaW50ZXJmYWNlIFZpZGVvUHJvcHMyIGV4dGVuZHMgVmlkZW9Qcm9wcyB7XG5cdGlkLFxufVxuXG5lbnVtIFNvcnRGaWVsZCB7XG5cdFRoZU93bCA9ICdzY29yZScsXG5cdFBlcmNlbnRDaGFuZ2UgPSAncGVyY2VudCcsXG5cdENoYW5nZUNvdW50ID0gJ2NoYW5nZScsXG59XG5cbmVudW0gU29ydERpcmVjdGlvbiB7XG5cdEFzY2VuZGluZyA9ICdhc2MnLFxuXHREZXNjZW5kaW5nID0gJ2Rlc2MnLFxufVxuXG5pbnRlcmZhY2UgUHJvcHMge1xuXHRhY3RpdmVWaWRlb3M6IFZpZGVvUHJvcHMyW11cblx0bG9jYXRpb246IHtcblx0XHRhY3Rpb246IHN0cmluZyxcblx0XHRkZWx0YT86IG51bWJlcixcblx0XHRoYXNoOiBzdHJpbmcsXG5cdFx0aW5kZXg/OiBudW1iZXIsXG5cdFx0a2V5Pzogc3RyaW5nLFxuXHRcdHBhdGhuYW1lOiBzdHJpbmcsXG5cdFx0c2VhcmNoOiBzdHJpbmcsXG5cdH1cbn1cblxuaW50ZXJmYWNlIFN0YXRlIHtcblx0dmlkZW9PZmZzZXRzOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9XG59XG5cbmNsYXNzIFZpZGVvTGlzdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxQcm9wcywgU3RhdGU+IHtcblxuXHRwcml2YXRlIGVsOiBIVE1MRWxlbWVudHxudWxsXG5cblx0Y29uc3RydWN0b3IocHJvcHMpIHtcblx0XHRzdXBlcihwcm9wcylcblx0XHR0aGlzLnN0YXRlID0ge1xuXHRcdFx0dmlkZW9PZmZzZXRzOiB7fVxuXHRcdH1cblx0fVxuXG5cdGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBQcm9wcykge1xuXHRcdGNvbnN0IHsgc2VhcmNoOiBuZXh0U2VhcmNoIH0gPSBuZXh0UHJvcHMubG9jYXRpb25cblx0XHRjb25zdCB7IHNlYXJjaCB9ID0gdGhpcy5wcm9wcy5sb2NhdGlvblxuXG5cdFx0aWYgKHNlYXJjaCAhPT0gbmV4dFNlYXJjaClcblx0XHRcdHRoaXMuc2V0U3RhdGUoe1xuXHRcdFx0XHR2aWRlb09mZnNldHM6IHt9XG5cdFx0XHR9KVxuXHR9XG5cblx0Y29tcG9uZW50RGlkTW91bnQoKSB7XG5cdFx0Y29uc29sZS5kZWJ1ZygnZGlkIG1vdW50Jylcblx0XHR0aGlzLnNjb29jaEl0ZW1zKClcblx0fVxuXG5cdGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcblx0XHRjb25zb2xlLmRlYnVnKCdkaWQgdXBkYXRlJylcblx0XHRpZiAoT2JqZWN0LmtleXModGhpcy5zdGF0ZS52aWRlb09mZnNldHMpLmxlbmd0aCA9PT0gMClcblx0XHRcdHRoaXMuc2Nvb2NoSXRlbXMoKVxuXHR9XG5cblx0cmVuZGVyKCkge1xuXHRcdGNvbnN0IHsgc29ydGVkIH0gPSB0aGlzXG5cblx0XHRjb25zdCBwZXJjZW50czogbnVtYmVyW10gPSBzb3J0ZWQubWFwKHZpZCA9PiB2aWQucGVyY2VudClcblx0XHRsZXQgY2hhcnRTY2FsZSA9IE1hdGgubWF4KDAsIC4uLnBlcmNlbnRzKSAvIDEwMCArIDFcblx0XHRpZiAoY2hhcnRTY2FsZSA8IDIpXG5cdFx0XHRjaGFydFNjYWxlID0gMlxuXG5cdFx0Y29uc3Qgc25hcHNob3RDb3VudHMgPSBzb3J0ZWQubWFwKHZpZCA9PiB7XG5cdFx0XHRyZXR1cm4gdmlkLnZpZGVvLnNuYXBzaG90cy5sZW5ndGhcblx0XHR9KVxuXHRcdGNvbnN0IG1heFNuYXBzaG90Q291bnQgPSBNYXRoLm1heCgwLCAuLi5zbmFwc2hvdENvdW50cylcblxuXHRcdGNvbnN0IHZpZGVvcyA9IHNvcnRlZC5tYXAodmlkID0+IHtcblx0XHRcdGxldCBzdHlsZTogUmVhY3QuQ1NTUHJvcGVydGllcyA9IHt9XG5cblx0XHRcdGNvbnN0IG9mZnNldCA9IHRoaXMuc3RhdGUudmlkZW9PZmZzZXRzW3ZpZC52aWRlby5pZF1cblx0XHRcdGlmIChvZmZzZXQpXG5cdFx0XHRcdHN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGVZKCR7b2Zmc2V0fXB4KWBcblxuXHRcdFx0Y29uc3QgaWQgPSBgdmlkZW8tJHt2aWQudmlkZW8uaWR9YFxuXG5cdFx0XHRyZXR1cm4gKFxuXHRcdFx0XHQ8VmlkZW8ga2V5PXt2aWQudmlkZW8uaWR9IGlkPXtpZH0gdmlkZW89e3ZpZC52aWRlb30gc3R5bGU9e3N0eWxlfVxuXHRcdFx0XHQgICAgICAgY2hhcnRTY2FsZT17Y2hhcnRTY2FsZX1cblx0XHRcdFx0ICAgICAgIGNoYXJ0RGF0YVBvdW50Q291bnQ9e21heFNuYXBzaG90Q291bnR9IC8+XG5cdFx0XHQpXG5cdFx0fSlcblxuXHRcdHJldHVybiAoXG5cdFx0XHQ8c2VjdGlvbiBjbGFzc05hbWU9XCJ2aWRlby1saXN0XCIgcmVmPXtyZWYgPT4gdGhpcy5lbCA9IHJlZn0+XG5cdFx0XHRcdDxuYXY+XG5cdFx0XHRcdFx0PGgxPk9yZGVyOjwvaDE+XG5cdFx0XHRcdFx0PHVsPlxuXHRcdFx0XHRcdFx0e3RoaXMuc29ydExpbmtzfVxuXHRcdFx0XHRcdDwvdWw+XG5cdFx0XHRcdDwvbmF2PlxuXHRcdFx0XHQ8ZGl2IGNsYXNzTmFtZT1cIml0ZW1zXCI+XG5cdFx0XHRcdFx0e3ZpZGVvc31cblx0XHRcdFx0PC9kaXY+XG5cdFx0XHQ8L3NlY3Rpb24+XG5cdFx0KVxuXHR9XG5cblx0cHJpdmF0ZSBnZXQgZ2V0UGFyYW1zKCk6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9IHtcblx0XHRjb25zdCB7IHNlYXJjaCB9ID0gdGhpcy5wcm9wcy5sb2NhdGlvblxuXG5cdFx0aWYgKCFzZWFyY2ggfHwgc2VhcmNoLmxlbmd0aCA9PT0gMSlcblx0XHRcdHJldHVybiB7fVxuXG5cdFx0cmV0dXJuIHNlYXJjaFxuXHRcdFx0LnNsaWNlKDEpXG5cdFx0XHQuc3BsaXQoJyYnKVxuXHRcdFx0LnJlZHVjZSgoYWNjbCwgcGFpcikgPT4ge1xuXHRcdFx0XHRjb25zdCBba2V5LCB2YWx1ZV0gPSBwYWlyLnNwbGl0KCc9JykubWFwKGRlY29kZVVSSUNvbXBvbmVudClcblx0XHRcdFx0YWNjbFtrZXldID0gdmFsdWVcblx0XHRcdFx0cmV0dXJuIGFjY2xcblx0XHRcdH0sIHt9KVxuXHR9XG5cblx0cHJpdmF0ZSBnZXQgc29ydCgpOiB7IGZpZWxkOiBTb3J0RmllbGQsIGRpcmVjdGlvbjogU29ydERpcmVjdGlvbiB9IHtcblx0XHRsZXQgeyBzb3J0RmllbGQ6IGZpZWxkLCBzb3J0RGlyZWN0aW9uOiBkaXJlY3Rpb24gfSA9IHRoaXMuZ2V0UGFyYW1zXG5cblx0XHRjb25zdCBmaWVsZHMgPSBPYmplY3Qua2V5cyhTb3J0RmllbGQpLm1hcChrZXkgPT4ge1xuXHRcdFx0cmV0dXJuIFNvcnRGaWVsZFtrZXldXG5cdFx0fSlcblx0XHRjb25zdCBkaXJlY3Rpb25zID0gT2JqZWN0LmtleXMoU29ydERpcmVjdGlvbikubWFwKGtleSA9PiB7XG5cdFx0XHRyZXR1cm4gU29ydERpcmVjdGlvbltrZXldXG5cdFx0fSlcblxuXHRcdGlmICghZmllbGQgfHwgZmllbGRzLmluZGV4T2YoZmllbGQpID09PSAtMSlcblx0XHRcdGZpZWxkID0gU29ydEZpZWxkLlRoZU93bFxuXHRcdGlmICghZGlyZWN0aW9uIHx8IGRpcmVjdGlvbnMuaW5kZXhPZihkaXJlY3Rpb24pID09PSAtMSlcblx0XHRcdGRpcmVjdGlvbiA9IFNvcnREaXJlY3Rpb24uRGVzY2VuZGluZ1xuXG5cdFx0cmV0dXJuIHsgZmllbGQ6IGZpZWxkIGFzIFNvcnRGaWVsZCwgZGlyZWN0aW9uOiBkaXJlY3Rpb24gYXMgU29ydERpcmVjdGlvbiB9XG5cdH1cblxuXHRwcml2YXRlIGdldCBzb3J0TGlua3MoKSB7XG5cdFx0Y29uc3Qgc29ydHMgPSB7XG5cdFx0XHRbU29ydEZpZWxkLlRoZU93bF06ICdBcyB0aGUgT3dsIEZsaWVzJyxcblx0XHRcdFtTb3J0RmllbGQuQ2hhbmdlQ291bnRdOiAnQ291bnQnLFxuXHRcdFx0W1NvcnRGaWVsZC5QZXJjZW50Q2hhbmdlXTogJ1BlcmNlbnQnLFxuXHRcdH1cblxuXHRcdHJldHVybiBPYmplY3Qua2V5cyhzb3J0cykubWFwKGZpZWxkID0+IHtcblx0XHRcdGNvbnN0IGlzQWN0aXZlID0gZmllbGQgPT09IHRoaXMuc29ydC5maWVsZFxuXHRcdFx0Y29uc3QgY2xhc3Nlczogc3RyaW5nW10gPSBbXVxuXG5cdFx0XHRpZiAoaXNBY3RpdmUpXG5cdFx0XHRcdGNsYXNzZXMucHVzaCgnYWN0aXZlJylcblxuXHRcdFx0Y29uc3Qgc29ydERpcmVjdGlvbiA9XG5cdFx0XHRcdGlzQWN0aXZlICYmIHRoaXMuc29ydC5kaXJlY3Rpb24gPT09IFNvcnREaXJlY3Rpb24uRGVzY2VuZGluZ1xuXHRcdFx0XHQ/IFNvcnREaXJlY3Rpb24uQXNjZW5kaW5nIDogU29ydERpcmVjdGlvbi5EZXNjZW5kaW5nXG5cdFx0XHRjbGFzc2VzLnB1c2goc29ydERpcmVjdGlvbilcblxuXHRcdFx0Y29uc3QgcGFyYW1zID0geyBzb3J0RmllbGQ6IGZpZWxkLCBzb3J0RGlyZWN0aW9uIH1cblx0XHRcdGNvbnN0IHNlYXJjaCA9IE9iamVjdC5rZXlzKHBhcmFtcykubWFwKGtleSA9PiB7XG5cdFx0XHRcdHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChwYXJhbXNba2V5XSlcblx0XHRcdH0pXG5cblx0XHRcdHJldHVybiAoXG5cdFx0XHRcdDxsaSBrZXk9e2ZpZWxkfSBjbGFzc05hbWU9e2NsYXNzZXMuam9pbignICcpfT5cblx0XHRcdFx0XHQ8TGluayB0bz17e1xuXHRcdFx0XHRcdFx0cGF0aG5hbWU6IHRoaXMucHJvcHMubG9jYXRpb24ucGF0aG5hbWUsXG5cdFx0XHRcdFx0XHRzZWFyY2g6ICc/JyArIHNlYXJjaC5qb2luKCcmJylcblx0XHRcdFx0XHR9fT5cblx0XHRcdFx0XHRcdHtzb3J0c1tmaWVsZF19XG5cdFx0XHRcdFx0PC9MaW5rPlxuXHRcdFx0XHQ8L2xpPlxuXHRcdFx0KVxuXHRcdH0pXG5cdH1cblxuXHRwcml2YXRlIGdldCBzY29yZWQoKSB7XG5cdFx0cmV0dXJuIHRoaXMucHJvcHMuYWN0aXZlVmlkZW9zLm1hcCh2aWQgPT4ge1xuXHRcdFx0Y29uc3Qgc3RhcnQgPSBmaXJzdCh2aWQuc25hcHNob3RzKVxuXHRcdFx0Y29uc3QgZW5kICA9IGxhc3QodmlkLnNuYXBzaG90cylcblxuXHRcdFx0Y29uc3Qgc3RhcnRDb3VudCA9IHN0YXJ0ICE9IG51bGxcblx0XHRcdFx0PyBbc3RhcnQudmlld3MsIHN0YXJ0Lmxpa2VzLCBzdGFydC5kaXNsaWtlcywgc3RhcnQuZmF2b3JpdGVzLFxuXHRcdFx0XHRcdHN0YXJ0LmNvbW1lbnRzXVxuXHRcdFx0XHRcdC5tYXAoTnVtYmVyKS5yZWR1Y2UoKHN1bSwgbnVtKSA9PiBzdW0gKyBudW0sIDApXG5cdFx0XHRcdDogMFxuXHRcdFx0Y29uc3QgZW5kQ291bnQgPSBlbmQgIT0gbnVsbFxuXHRcdFx0XHQ/IFtlbmQudmlld3MsIGVuZC5saWtlcywgZW5kLmRpc2xpa2VzLCBlbmQuZmF2b3JpdGVzLCBlbmQuY29tbWVudHNdXG5cdFx0XHRcdFx0Lm1hcChOdW1iZXIpLnJlZHVjZSgoc3VtLCBudW0pID0+IHN1bSArIG51bSwgMClcblx0XHRcdFx0OiAwXG5cblx0XHRcdGNvbnN0IGNoYW5nZSAgPSBlbmRDb3VudCAtIHN0YXJ0Q291bnRcblx0XHRcdGNvbnN0IHJhdGlvICAgPSAoZW5kQ291bnQgLyBzdGFydENvdW50KSB8fCAwXG5cblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdHZpZGVvOiB2aWQsXG5cdFx0XHRcdHNjb3JlOiBjaGFuZ2UgKiAocmF0aW8tMSkqKjIsXG5cdFx0XHRcdHBlcmNlbnQ6IChyYXRpbyAqIDEwMCkgLSAxMDAsXG5cdFx0XHRcdGNoYW5nZSxcblx0XHRcdH1cblx0XHR9KVxuXHR9XG5cblx0cHJpdmF0ZSBnZXQgc29ydGVkKCkge1xuXHRcdHJldHVybiB0aGlzLnNjb3JlZC5zb3J0KCh2aWQxLCB2aWQyKSA9PiB7XG5cdFx0XHRjb25zdCB7IGZpZWxkLCBkaXJlY3Rpb24gfSA9IHRoaXMuc29ydFxuXG5cdFx0XHRjb25zdCBbYSwgYl0gPSBkaXJlY3Rpb24gPT09IFNvcnREaXJlY3Rpb24uRGVzY2VuZGluZ1xuXHRcdFx0XHQ/IFt2aWQyLCB2aWQxXSA6IFt2aWQxLCB2aWQyXVxuXG5cdFx0XHQvLyBGaWVsZCB2YWx1ZXMgY2FuIGJlIE5hTi4gUHJldmVudHMgaXRlbXMgd2l0aG91dCBzdGF0cyBzb3J0aW5nIHdlaXJkbHkuXG5cdFx0XHRyZXR1cm4gKGFbZmllbGRdIHx8IDApIC0gKGJbZmllbGRdIHx8IDApXG5cdFx0fSlcblx0fVxuXG5cblx0cHJpdmF0ZSBzY29vY2hJdGVtcygpOiB2b2lkIHtcblx0XHRjb25zb2xlLmRlYnVnKCdzY29vY2hpbmcnKVxuXHRcdGlmICghdGhpcy5lbClcblx0XHRcdHJldHVybjtcblxuXHRcdGludGVyZmFjZSBJdGVtIHsgZWw6IEVsZW1lbnQsIHRvcDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciB9XG5cblx0XHRjb25zdCBpdGVtRWxlbWVudHMgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoXG5cdFx0XHQnOnNjb3BlID4gLml0ZW1zID4gKidcblx0XHQpXG5cblx0XHRjb25zdCBpdGVtczogSXRlbVtdID0gW11cblx0XHRpdGVtRWxlbWVudHMuZm9yRWFjaChlbCA9PiB7XG5cdFx0XHRsZXQgeyB0b3AsIGhlaWdodCB9ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcblx0XHRcdGNvbnN0IHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKVxuXG5cdFx0XHRoZWlnaHQgKz0gKHBhcnNlSW50KHN0eWxlcy5tYXJnaW5Ub3AgICAgfHwgJzAnLCAxMCkgfHwgMClcblx0XHRcdCAgICAgICAgKyAocGFyc2VJbnQoc3R5bGVzLm1hcmdpbkJvdHRvbSB8fCAnMCcsIDEwKSB8fCAwKVxuXG5cdFx0XHRpdGVtcy5wdXNoKHsgZWwsIHRvcCwgaGVpZ2h0IH0pXG5cdFx0fSlcblxuXHRcdGxldCBwcmV2Q29sOiBudW1iZXJcblx0XHRjb25zdCBjb2x1bW5zID0gaXRlbXMucmVkdWNlKChjb2x1bW5zLCBpdGVtLCBpbmRleCkgPT4ge1xuXHRcdFx0bGV0IGNvbDogbnVtYmVyfHVuZGVmaW5lZFxuXG5cdFx0XHRpZiAoY29sdW1ucy5sZW5ndGggPT09IDApXG5cdFx0XHRcdGNvbCA9IDBcblx0XHRcdGVsc2UgaWYgKGNvbHVtbnMubGVuZ3RoID09PSBpbmRleCkge1xuXHRcdFx0XHQvLyBQb3RlbnRpYWxseSBuZWVkIHRvIGFkZCBhbm90aGVyIGNvbHVtbi5cblx0XHRcdFx0Y29uc3QgcHJldkl0ZW0gPSBsYXN0KGNvbHVtbnNbcHJldkNvbF0pIGFzIEl0ZW1cblx0XHRcdFx0aWYgKGl0ZW0udG9wID09PSBwcmV2SXRlbS50b3ApXG5cdFx0XHRcdFx0Y29sID0gY29sdW1ucy5sZW5ndGhcblx0XHRcdH1cblxuXHRcdFx0aWYgKGNvbCA9PT0gdW5kZWZpbmVkKVxuXHRcdFx0XHRjb2wgPSBpbmRleCAlIGNvbHVtbnMubGVuZ3RoXG5cblx0XHRcdGlmICghY29sdW1uc1tjb2xdKVxuXHRcdFx0XHRjb2x1bW5zW2NvbF0gPSBbXVxuXG5cdFx0XHRjb2x1bW5zW2NvbF0ucHVzaChpdGVtKVxuXHRcdFx0cHJldkNvbCA9IGNvbFxuXG5cdFx0XHRyZXR1cm4gY29sdW1uc1xuXHRcdH0sIFtdIGFzIEl0ZW1bXVtdKVxuXG5cdFx0Y29uc3QgdmlkZW9PZmZzZXRzOiB7IFtrZXk6IHN0cmluZ106IG51bWJlciB9ID0ge31cblx0XHRjb2x1bW5zLmZvckVhY2goKGl0ZW1zKSA9PiB7XG5cdFx0XHRsZXQgcHJldk9mZnNldCA9IDBcblx0XHRcdGl0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4LCBsaXN0KSA9PiB7XG5cdFx0XHRcdGNvbnN0IGlkID0gaXRlbS5lbC5nZXRBdHRyaWJ1dGUoJ2lkJylcblx0XHRcdFx0aWYgKGlkID09PSBudWxsKVxuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0Y29uc3Qga2V5ID0gaWQucmVwbGFjZSgvXnZpZGVvLS8sICcnKVxuXG5cdFx0XHRcdGlmIChpbmRleCA9PT0gMCkge1xuXHRcdFx0XHRcdHZpZGVvT2Zmc2V0c1trZXldID0gMFxuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGNvbnN0IHByZXZJdGVtID0gbGlzdFtpbmRleC0xXVxuXHRcdFx0XHRjb25zdCB5ID0gcHJldkl0ZW0udG9wICsgcHJldk9mZnNldCArIHByZXZJdGVtLmhlaWdodFxuXHRcdFx0XHR2aWRlb09mZnNldHNba2V5XSA9IHByZXZPZmZzZXQgPSB5IC0gaXRlbS50b3Bcblx0XHRcdH0pXG5cdFx0fSlcblxuXHRcdHRoaXMuc2V0U3RhdGUoeyB2aWRlb09mZnNldHMgfSlcblx0fVxuXG59XG5cblxuZXhwb3J0IGRlZmF1bHQgY3JlYXRlRnJhZ21lbnRDb250YWluZXIoVmlkZW9MaXN0LCBncmFwaHFsYFxuXHRmcmFnbWVudCBWaWRlb0xpc3RfYWN0aXZlVmlkZW9zIG9uIFZpZGVvIEByZWxheShwbHVyYWw6IHRydWUpIHtcblx0XHRpZFxuICAgIHNuYXBzaG90czogc3RhdHNCeUFnZShzZWNvbmRzOiAkc3RhdHNBZ2UpIHtcbiAgICAgIHZpZXdzXG4gICAgICBsaWtlc1xuICAgICAgZGlzbGlrZXNcbiAgICAgIGZhdm9yaXRlc1xuICAgICAgY29tbWVudHNcbiAgICB9XG5cdFx0Li4uVmlkZW9fdmlkZW9cblx0fVxuYClcbiJdfQ==