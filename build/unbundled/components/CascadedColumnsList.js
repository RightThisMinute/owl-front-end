"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const last = require("lodash/last");
const isEqual = require("lodash/isEqual");
const React = require("react");
const react_redux_1 = require("react-redux");
class CascadedColumnsList extends React.Component {
    constructor(props) {
        super(props);
        this.state = {
            offsets: {}
        };
        this.imageLoadHandler = this.updateOffsets.bind(this);
    }
    componentWillReceiveProps(props) {
        console.debug('resize in prog', props.viewportResizeInProgress);
        if (props.viewportResizeInProgress) {
            this.setState({ offsets: {} });
            return;
        }
        const { children: nextChildren } = props;
        const { children } = this.props;
        const getID = (child) => child.props.id;
        const ids = React.Children.map(children, getID);
        const nextIDs = React.Children.map(nextChildren, getID);
        if (!isEqual(ids, nextIDs)) {
            console.debug('reset');
            this.setState({ offsets: {} });
        }
    }
    componentWillUpdate() {
        this.unsetUpdateOnImageLoadListeners();
    }
    componentDidMount() {
        console.debug('did mount');
        if (!this.props.viewportResizeInProgress) {
            this.setUpdateOnImageLoadListeners();
            this.updateOffsets();
        }
    }
    componentDidUpdate() {
        console.debug('did update');
        if (!this.props.viewportResizeInProgress) {
            this.setUpdateOnImageLoadListeners();
            if (Object.keys(this.state.offsets).length === 0)
                this.updateOffsets();
        }
    }
    componentWillUnmount() {
        this.unsetUpdateOnImageLoadListeners();
    }
    render() {
        const children = React.Children.map(this.props.children, (child) => {
            let style = {};
            const offset = this.state.offsets[child.props.id];
            if (offset === undefined)
                return child;
            style.transform = `translateY(${offset}px)`;
            return React.cloneElement(child, { style });
        });
        return (React.createElement("div", { className: "items cascaded-column-list", ref: ref => this.el = ref }, children));
    }
    setUpdateOnImageLoadListeners() {
        if (!this.el)
            return;
        this.images = [];
        const images = this.el.getElementsByTagName('img');
        for (let i = 0; i < images.length; i++)
            this.images.push(images.item(i));
        this.images.forEach(img => {
            img.addEventListener('load', this.imageLoadHandler);
        });
    }
    unsetUpdateOnImageLoadListeners() {
        if (this.images === undefined)
            return;
        this.images.forEach(img => {
            img.addEventListener('load', this.imageLoadHandler);
        });
    }
    updateOffsets() {
        const offsets = this.computeOffsets();
        if (!isEqual(offsets, this.state.offsets))
            this.setState({ offsets });
    }
    computeOffsets() {
        console.debug('scooching');
        if (!this.el)
            return {};
        const elements = this.el.querySelectorAll(':scope > *');
        if (elements.length === 0)
            return {};
        // `this.elementToItem()` requires this to be set.
        this.offsetParentTop = elements.item(0).getBoundingClientRect().top;
        const items = [];
        elements.forEach(el => {
            items.push(this.elementToItem(el));
        });
        const columns = this.splitIntoColumns(items);
        if (columns.length === 1)
            return {};
        const offsets = columns.map(this.computeColumnOffsets.bind(this));
        return Object.assign({}, ...offsets);
    }
    elementToItem(element) {
        const top = this.offsetParentTop + element.offsetTop;
        // Get the true top position relative to the document root, unaffected by
        // any transforms.
        const styles = window.getComputedStyle(element);
        let { height } = element.getBoundingClientRect();
        height += (parseInt(styles.marginTop || '0', 10) || 0)
            + (parseInt(styles.marginBottom || '0', 10) || 0);
        return { el: element, top, height };
    }
    splitIntoColumns(items) {
        let prevCol;
        return items.reduce((columns, item, index) => {
            let col;
            if (columns.length === 0)
                col = 0;
            else if (columns.length === index) {
                // Potentially need to add another column.
                const prevItem = last(columns[prevCol]);
                if (item.top === prevItem.top)
                    col = columns.length;
            }
            if (col === undefined)
                col = index % columns.length;
            if (!columns[col])
                columns[col] = [];
            columns[col].push(item);
            prevCol = col;
            return columns;
        }, []);
    }
    computeColumnOffsets(items) {
        let prevOffset = 0;
        return items.reduce((offsets, item, index, list) => {
            const id = item.el.getAttribute('id');
            if (id === null)
                return offsets;
            if (index === 0) {
                offsets[id] = 0;
                return offsets;
            }
            const prevItem = list[index - 1];
            const y = prevItem.top + prevOffset + prevItem.height;
            offsets[id] = prevOffset = y - item.top;
            return offsets;
        }, {});
    }
}
function mapStateToProps(storeState, props) {
    const { rtmOwl: { viewport: { resizeInProgress } } } = storeState;
    return Object.assign({}, props, {
        viewportResizeInProgress: resizeInProgress
    });
}
exports.default = react_redux_1.connect(mapStateToProps)(CascadedColumnsList);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FzY2FkZWRDb2x1bW5zTGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL0Nhc2NhZGVkQ29sdW1uc0xpc3QudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esb0NBQW9DO0FBQ3BDLDBDQUEwQztBQUMxQywrQkFBOEI7QUFDOUIsNkNBQXFDO0FBcUNyQyx5QkFBMEIsU0FBUSxLQUFLLENBQUMsU0FBdUI7SUFPOUQsWUFBWSxLQUFLO1FBQ2hCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVaLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDWixPQUFPLEVBQUUsRUFBRTtTQUNYLENBQUE7UUFFRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDdEQsQ0FBQztJQUVELHlCQUF5QixDQUFDLEtBQVk7UUFDckMsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtRQUMvRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUM5QixNQUFNLENBQUM7UUFDUixDQUFDO1FBRUQsTUFBTSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsR0FBRyxLQUFLLENBQUE7UUFDeEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUE7UUFFL0IsTUFBTSxLQUFLLEdBQUcsQ0FBQyxLQUFZLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUE7UUFFOUMsTUFBTSxHQUFHLEdBQU8sS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQ25ELE1BQU0s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cG9ydCBpc0VxdWFsID0gcmVxdWlyZSgnbG9kYXNoL2lzRXF1YWwnKVxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBjb25uZWN0IH0gZnJvbSAncmVhY3QtcmVkdXgnXG5cbmltcG9ydCB7IFN0b3JlU3RhdGUgfSBmcm9tICcuLi9zdG9yZSdcblxuXG5pbnRlcmZhY2UgQ2hpbGRQcm9wcyB7XG5cdGlkOiBzdHJpbmdcblx0c3R5bGU6IFJlYWN0LkNTU1Byb3BlcnRpZXNcbn1cblxudHlwZSBDaGlsZCA9IFJlYWN0LlJlYWN0RWxlbWVudDxDaGlsZFByb3BzPlxudHlwZSBPZmZzZXRMaXN0ID0geyBba2V5OiBzdHJpbmddOiBudW1iZXIgfVxuXG5pbnRlcmZhY2UgT3duUHJvcHMge1xuXHRjaGlsZHJlbjogQ2hpbGRbXVxufVxuXG5pbnRlcmZhY2UgU3RhdGVQcm9wcyB7XG5cdHZpZXdwb3J0UmVzaXplSW5Qcm9ncmVzczogYm9vbGVhblxufVxuXG5pbnRlcmZhY2UgRGlzcGF0Y2hQcm9wcyB7fVxuXG5cbnR5cGUgUHJvcHMgPSBPd25Qcm9wcyAmIFN0YXRlUHJvcHMgJiBEaXNwYXRjaFByb3BzXG5cbmludGVyZmFjZSBTdGF0ZSB7XG5cdG9mZnNldHM6IE9mZnNldExpc3Rcbn1cblxuaW50ZXJmYWNlIEl0ZW0ge1xuXHRlbDogRWxlbWVudFxuXHR0b3A6IG51bWJlclxuXHRoZWlnaHQ6IG51bWJlclxufVxuXG5cbmNsYXNzIENhc2NhZGVkQ29sdW1uc0xpc3QgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XG5cblx0cHJpdmF0ZSBlbDogSFRNTEVsZW1lbnR8bnVsbFxuXHRwcml2YXRlIG9mZnNldFBhcmVudFRvcDogbnVtYmVyXG5cdHByaXZhdGUgaW1hZ2VzOiBIVE1MSW1hZ2VFbGVtZW50W118dW5kZWZpbmVkXG5cdHByaXZhdGUgaW1hZ2VMb2FkSGFuZGxlcjogKCkgPT4gdm9pZFxuXG5cdGNvbnN0cnVjdG9yKHByb3BzKSB7XG5cdFx0c3VwZXIocHJvcHMpXG5cblx0XHR0aGlzLnN0YXRlID0ge1xuXHRcdFx0b2Zmc2V0czoge31cblx0XHR9XG5cblx0XHR0aGlzLmltYWdlTG9hZEhhbmRsZXIgPSB0aGlzLnVwZGF0ZU9mZnNldHMuYmluZCh0aGlzKVxuXHR9XG5cblx0Y29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhwcm9wczogUHJvcHMpIHtcblx0XHRjb25zb2xlLmRlYnVnKCdyZXNpemUgaW4gcHJvZycsIHByb3BzLnZpZXdwb3J0UmVzaXplSW5Qcm9ncmVzcylcblx0XHRpZiAocHJvcHMudmlld3BvcnRSZXNpemVJblByb2dyZXNzKSB7XG5cdFx0XHR0aGlzLnNldFN0YXRlKHsgb2Zmc2V0czoge30gfSlcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCB7IGNoaWxkcmVuOiBuZXh0Q2hpbGRyZW4gfSA9IHByb3BzXG5cdFx0Y29uc3QgeyBjaGlsZHJlbiB9ID0gdGhpcy5wcm9wc1xuXG5cdFx0Y29uc3QgZ2V0SUQgPSAoY2hpbGQ6IENoaWxkKSA9PiBjaGlsZC5wcm9wcy5pZFxuXG5cdFx0Y29uc3QgaWRzICAgICA9IFJlYWN0LkNoaWxkcmVuLm1hcChjaGlsZHJlbiwgZ2V0SUQpXG5cdFx0Y29uc3QgbmV4dElEcyA9IFJlYWN0LkNoaWxkcmVuLm1hcChuZXh0Q2hpbGRyZW4sIGdldElEKVxuXG5cdFx0aWYgKCFpc0VxdWFsKGlkcywgbmV4dElEcykpIHtcblx0XHRcdGNvbnNvbGUuZGVidWcoJ3Jlc2V0Jylcblx0XHRcdHRoaXMuc2V0U3RhdGUoeyBvZmZzZXRzOiB7fSB9KVxuXHRcdH1cblx0fVxuXG5cdGNvbXBvbmVudFdpbGxVcGRhdGUoKSB7XG5cdFx0dGhpcy51bnNldFVwZGF0ZU9uSW1hZ2VMb2FkTGlzdGVuZXJzKClcblx0fVxuXG5cdGNvbXBvbmVudERpZE1vdW50KCkge1xuXHRcdGNvbnNvbGUuZGVidWcoJ2RpZCBtb3VudCcpXG5cdFx0aWYgKCF0aGlzLnByb3BzLnZpZXdwb3J0UmVzaXplSW5Qcm9ncmVzcykge1xuXHRcdFx0dGhpcy5zZXRVcGRhdGVPbkltYWdlTG9hZExpc3RlbmVycygpXG5cdFx0XHR0aGlzLnVwZGF0ZU9mZnNldHMoKVxuXHRcdH1cblx0fVxuXG5cdGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcblx0XHRjb25zb2xlLmRlYnVnKCdkaWQgdXBkYXRlJylcblx0XHRpZiAoIXRoaXMucHJvcHMudmlld3BvcnRSZXNpemVJblByb2dyZXNzKSB7XG5cdFx0XHR0aGlzLnNldFVwZGF0ZU9uSW1hZ2VMb2FkTGlzdGVuZXJzKClcblx0XHRcdGlmIChPYmplY3Qua2V5cyh0aGlzLnN0YXRlLm9mZnNldHMpLmxlbmd0aCA9PT0gMClcblx0XHRcdFx0dGhpcy51cGRhdGVPZmZzZXRzKClcblx0XHR9XG5cdH1cblxuXHRjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcblx0XHR0aGlzLnVuc2V0VXBkYXRlT25JbWFnZUxvYWRMaXN0ZW5lcnMoKVxuXHR9XG5cblx0cmVuZGVyKCkge1xuXHRcdGNvbnN0IGNoaWxkcmVuID0gUmVhY3QuQ2hpbGRyZW4ubWFwKHRoaXMucHJvcHMuY2hpbGRyZW4sXG5cdFx0KGNoaWxkOiBDaGlsZCkgPT4ge1xuXHRcdFx0bGV0IHN0eWxlOiBSZWFjdC5DU1NQcm9wZXJ0aWVzID0ge31cblxuXHRcdFx0Y29uc3Qgb2Zmc2V0OiBudW1iZXJ8dW5kZWZpbmVkID0gdGhpcy5zdGF0ZS5vZmZzZXRzW2NoaWxkLnByb3BzLmlkXVxuXHRcdFx0aWYgKG9mZnNldCA9PT0gdW5kZWZpbmVkKVxuXHRcdFx0XHRyZXR1cm4gY2hpbGRcblxuXHRcdFx0c3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZVkoJHtvZmZzZXR9cHgpYFxuXHRcdFx0cmV0dXJuIFJlYWN0LmNsb25lRWxlbWVudChjaGlsZCwgeyBzdHlsZSB9KVxuXHRcdH0pXG5cblx0XHRyZXR1cm4gKFxuXHRcdFx0PGRpdiBjbGFzc05hbWU9XCJpdGVtcyBjYXNjYWRlZC1jb2x1bW4tbGlzdFwiXG5cdFx0XHQgICAgIHJlZj17cmVmID0+IHRoaXMuZWwgPSByZWZ9PlxuXHRcdFx0XHR7Y2hpbGRyZW59XG5cdFx0XHQ8L2Rpdj5cblx0XHQpXG5cdH1cblxuXHRwcml2YXRlIHNldFVwZGF0ZU9uSW1hZ2VMb2FkTGlzdGVuZXJzKCk6IHZvaWQge1xuXHRcdGlmICghdGhpcy5lbClcblx0XHRcdHJldHVybjtcblxuXHRcdHRoaXMuaW1hZ2VzID0gW11cblx0XHRjb25zdCBpbWFnZXMgPSB0aGlzLmVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbWcnKVxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgaW1hZ2VzLmxlbmd0aDsgaSsrKVxuXHRcdFx0dGhpcy5pbWFnZXMucHVzaChpbWFnZXMuaXRlbShpKSlcblxuXHRcdHRoaXMuaW1hZ2VzLmZvckVhY2goaW1nID0+IHtcblx0XHRcdGltZy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgdGhpcy5pbWFnZUxvYWRIYW5kbGVyKVxuXHRcdH0pXG5cdH1cblxuXHRwcml2YXRlIHVuc2V0VXBkYXRlT25JbWFnZUxvYWRMaXN0ZW5lcnMoKTogdm9pZCB7XG5cdFx0aWYgKHRoaXMuaW1hZ2VzID09PSB1bmRlZmluZWQpXG5cdFx0XHRyZXR1cm47XG5cblx0XHR0aGlzLmltYWdlcy5mb3JFYWNoKGltZyA9PiB7XG5cdFx0XHRpbWcuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIHRoaXMuaW1hZ2VMb2FkSGFuZGxlcilcblx0XHR9KVxuXHR9XG5cblx0cHJpdmF0ZSB1cGRhdGVPZmZzZXRzKCk6IHZvaWQge1xuXHRcdGNvbnN0IG9mZnNldHMgPSB0aGlzLmNvbXB1dGVPZmZzZXRzKClcblx0XHRpZiAoIWlzRXF1YWwob2Zmc2V0cywgdGhpcy5zdGF0ZS5vZmZzZXRzKSlcblx0XHRcdHRoaXMuc2V0U3RhdGUoeyBvZmZzZXRzIH0pXG5cdH1cblxuXHRwcml2YXRlIGNvbXB1dGVPZmZzZXRzKCk6IE9mZnNldExpc3Qge1xuXHRcdGNvbnNvbGUuZGVidWcoJ3Njb29jaGluZycpXG5cdFx0aWYgKCF0aGlzLmVsKVxuXHRcdFx0cmV0dXJuIHt9O1xuXG5cdFx0Y29uc3QgZWxlbWVudHMgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoJzpzY29wZSA+IConKVxuXHRcdGlmIChlbGVtZW50cy5sZW5ndGggPT09IDApXG5cdFx0XHRyZXR1cm4ge307XG5cblx0XHQvLyBgdGhpcy5lbGVtZW50VG9JdGVtKClgIHJlcXVpcmVzIHRoaXMgdG8gYmUgc2V0LlxuXHRcdHRoaXMub2Zmc2V0UGFyZW50VG9wID0gZWxlbWVudHMuaXRlbSgwKS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3BcblxuXHRcdGNvbnN0IGl0ZW1zOiBJdGVtW10gPSBbXVxuXHRcdGVsZW1lbnRzLmZvckVhY2goZWwgPT4ge1xuXHRcdFx0aXRlbXMucHVzaCh0aGlzLmVsZW1lbnRUb0l0ZW0oZWwgYXMgSFRNTEVsZW1lbnQpKVxuXHRcdH0pXG5cblx0XHRjb25zdCBjb2x1bW5zID0gdGhpcy5zcGxpdEludG9Db2x1bW5zKGl0ZW1zKVxuXHRcdGlmIChjb2x1bW5zLmxlbmd0aCA9PT0gMSlcblx0XHRcdHJldHVybiB7fVxuXG5cdFx0Y29uc3Qgb2Zmc2V0czogT2Zmc2V0TGlzdFtdID1cblx0XHRcdGNvbHVtbnMubWFwKHRoaXMuY29tcHV0ZUNvbHVtbk9mZnNldHMuYmluZCh0aGlzKSlcblxuXHRcdHJldHVybiBPYmplY3QuYXNzaWduKHt9LCAuLi5vZmZzZXRzKVxuXHR9XG5cblx0ZWxlbWVudFRvSXRlbShlbGVtZW50OiBIVE1MRWxlbWVudCk6IEl0ZW0ge1xuXHRcdGNvbnN0IHRvcCA9IHRoaXMub2Zmc2V0UGFyZW50VG9wICsgZWxlbWVudC5vZmZzZXRUb3Bcblx0XHRcdC8vIEdldCB0aGUgdHJ1ZSB0b3AgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIGRvY3VtZW50IHJvb3QsIHVuYWZmZWN0ZWQgYnlcblx0XHRcdC8vIGFueSB0cmFuc2Zvcm1zLlxuXHRcdGNvbnN0IHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQpXG5cblx0XHRsZXQgeyBoZWlnaHQgfSA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcblx0XHRoZWlnaHQgKz0gKHBhcnNlSW50KHN0eWxlcy5tYXJnaW5Ub3AgICAgfHwgJzAnLCAxMCkgfHwgMClcblx0XHQgICAgICAgICsgKHBhcnNlSW50KHN0eWxlcy5tYXJnaW5Cb3R0b20gfHwgJzAnLCAxMCkgfHwgMClcblxuXHRcdHJldHVybiB7IGVsOiBlbGVtZW50LCB0b3AsIGhlaWdodCB9XG5cdH1cblxuXHRzcGxpdEludG9Db2x1bW5zKGl0ZW1zOiBJdGVtW10pOiBJdGVtW11bXSB7XG5cdFx0bGV0IHByZXZDb2w6IG51bWJlclxuXG5cdFx0cmV0dXJuIGl0ZW1zLnJlZHVjZSgoY29sdW1ucywgaXRlbSwgaW5kZXgpID0+IHtcblx0XHRcdGxldCBjb2w6IG51bWJlcnx1bmRlZmluZWRcblxuXHRcdFx0aWYgKGNvbHVtbnMubGVuZ3RoID09PSAwKVxuXHRcdFx0XHRjb2wgPSAwXG5cdFx0XHRlbHNlIGlmIChjb2x1bW5zLmxlbmd0aCA9PT0gaW5kZXgpIHtcblx0XHRcdFx0Ly8gUG90ZW50aWFsbHkgbmVlZCB0byBhZGQgYW5vdGhlciBjb2x1bW4uXG5cdFx0XHRcdGNvbnN0IHByZXZJdGVtID0gbGFzdChjb2x1bW5zW3ByZXZDb2xdKSBhcyBJdGVtXG5cdFx0XHRcdGlmIChpdGVtLnRvcCA9PT0gcHJldkl0ZW0udG9wKVxuXHRcdFx0XHRcdGNvbCA9IGNvbHVtbnMubGVuZ3RoXG5cdFx0XHR9XG5cblx0XHRcdGlmIChjb2wgPT09IHVuZGVmaW5lZClcblx0XHRcdFx0Y29sID0gaW5kZXggJSBjb2x1bW5zLmxlbmd0aFxuXG5cdFx0XHRpZiAoIWNvbHVtbnNbY29sXSlcblx0XHRcdFx0Y29sdW1uc1tjb2xdID0gW11cblxuXHRcdFx0Y29sdW1uc1tjb2xdLnB1c2goaXRlbSlcblx0XHRcdHByZXZDb2wgPSBjb2xcblxuXHRcdFx0cmV0dXJuIGNvbHVtbnNcblx0XHR9LCBbXSBhcyBJdGVtW11bXSlcblx0fVxuXG5cdGNvbXB1dGVDb2x1bW5PZmZzZXRzKGl0ZW1zOiBJdGVtW10pOiBPZmZzZXRMaXN0IHtcblx0XHRsZXQgcHJldk9mZnNldCA9IDBcblxuXHRcdHJldHVybiBpdGVtcy5yZWR1Y2UoKG9mZnNldHMsIGl0ZW0sIGluZGV4LCBsaXN0KSA9PiB7XG5cdFx0XHRjb25zdCBpZCA9IGl0ZW0uZWwuZ2V0QXR0cmlidXRlKCdpZCcpXG5cdFx0XHRpZiAoaWQgPT09IG51bGwpXG5cdFx0XHRcdHJldHVybiBvZmZzZXRzO1xuXG5cdFx0XHRpZiAoaW5kZXggPT09IDApIHtcblx0XHRcdFx0b2Zmc2V0c1tpZF0gPSAwXG5cdFx0XHRcdHJldHVybiBvZmZzZXRzO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBwcmV2SXRlbSA9IGxpc3RbaW5kZXgtMV1cblx0XHRcdGNvbnN0IHkgPSBwcmV2SXRlbS50b3AgKyBwcmV2T2Zmc2V0ICsgcHJldkl0ZW0uaGVpZ2h0XG5cdFx0XHRvZmZzZXRzW2lkXSA9IHByZXZPZmZzZXQgPSB5IC0gaXRlbS50b3BcblxuXHRcdFx0cmV0dXJuIG9mZnNldHNcblx0XHR9LCB7fSBhcyBPZmZzZXRMaXN0KVxuXHR9XG5cbn1cblxuXG5mdW5jdGlvbiBtYXBTdGF0ZVRvUHJvcHMoc3RvcmVTdGF0ZTogU3RvcmVTdGF0ZSwgcHJvcHM6IFByb3BzKTogU3RhdGVQcm9wcyB7XG5cdGNvbnN0IHsgcnRtT3dsOiB7IHZpZXdwb3J0OiB7IHJlc2l6ZUluUHJvZ3Jlc3MgfSB9IH0gPSBzdG9yZVN0YXRlXG5cblx0cmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHByb3BzLCB7XG5cdFx0dmlld3BvcnRSZXNpemVJblByb2dyZXNzOiByZXNpemVJblByb2dyZXNzXG5cdH0pXG59XG5cbmV4cG9ydCBkZWZhdWx0IGNvbm5lY3Q8U3RhdGVQcm9wcywgRGlzcGF0Y2hQcm9wcywgT3duUHJvcHM+KFxuXHRtYXBTdGF0ZVRvUHJvcHNcbikoQ2FzY2FkZWRDb2x1bW5zTGlzdClcbiJdfQ==