"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const last = require("lodash/last");
const isEqual = require("lodash/isEqual");
const React = require("react");
const react_redux_1 = require("react-redux");
class CascadedColumnsList extends React.Component {
    constructor(props) {
        super(props);
        this.state = {
            offsets: {}
        };
        this.imageLoadHandler = this.updateOffsets.bind(this);
    }
    componentWillReceiveProps(props) {
        if (props.viewportResizeInProgress) {
            this.setState({ offsets: {} });
            return;
        }
        const { children: nextChildren } = props;
        const { children } = this.props;
        const getID = (child) => child.props.id;
        const ids = React.Children.map(children, getID);
        const nextIDs = React.Children.map(nextChildren, getID);
        if (!isEqual(ids, nextIDs))
            this.setState({ offsets: {} });
    }
    componentWillUpdate() {
        this.unsetUpdateOnImageLoadListeners();
    }
    componentDidMount() {
        if (!this.props.viewportResizeInProgress) {
            this.setUpdateOnImageLoadListeners();
            this.updateOffsets();
        }
    }
    componentDidUpdate() {
        if (!this.props.viewportResizeInProgress) {
            this.setUpdateOnImageLoadListeners();
            if (Object.keys(this.state.offsets).length === 0)
                this.updateOffsets();
        }
    }
    componentWillUnmount() {
        this.unsetUpdateOnImageLoadListeners();
    }
    render() {
        const children = React.Children.map(this.props.children, (child) => {
            let style = {};
            const offset = this.state.offsets[child.props.id];
            if (offset === undefined)
                return child;
            style.transform = `translateY(${offset}px)`;
            return React.cloneElement(child, { style });
        });
        return (React.createElement("div", { className: "items cascaded-column-list", ref: ref => this.el = ref }, children));
    }
    setUpdateOnImageLoadListeners() {
        if (!this.el)
            return;
        this.images = [];
        const images = this.el.getElementsByTagName('img');
        for (let i = 0; i < images.length; i++)
            this.images.push(images.item(i));
        this.images.forEach(img => {
            img.addEventListener('load', this.imageLoadHandler);
        });
    }
    unsetUpdateOnImageLoadListeners() {
        if (this.images === undefined)
            return;
        this.images.forEach(img => {
            img.addEventListener('load', this.imageLoadHandler);
        });
    }
    updateOffsets() {
        const offsets = this.computeOffsets();
        if (!isEqual(offsets, this.state.offsets))
            this.setState({ offsets });
    }
    computeOffsets() {
        if (!this.el)
            return {};
        const elements = this.el.querySelectorAll(':scope > *');
        if (elements.length === 0)
            return {};
        // `this.elementToItem()` requires this to be set.
        this.offsetParentTop = elements.item(0).getBoundingClientRect().top;
        const items = [];
        elements.forEach(el => {
            items.push(this.elementToItem(el));
        });
        const columns = this.splitIntoColumns(items);
        if (columns.length === 1)
            return {};
        const offsets = columns.map(this.computeColumnOffsets.bind(this));
        return Object.assign({}, ...offsets);
    }
    elementToItem(element) {
        const top = this.offsetParentTop + element.offsetTop;
        // Get the true top position relative to the document root, unaffected by
        // any transforms.
        const styles = window.getComputedStyle(element);
        let { height } = element.getBoundingClientRect();
        height += (parseInt(styles.marginTop || '0', 10) || 0)
            + (parseInt(styles.marginBottom || '0', 10) || 0);
        return { el: element, top, height };
    }
    splitIntoColumns(items) {
        let prevCol;
        return items.reduce((columns, item, index) => {
            let col;
            if (columns.length === 0)
                col = 0;
            else if (columns.length === index) {
                // Potentially need to add another column.
                const prevItem = last(columns[prevCol]);
                if (item.top === prevItem.top)
                    col = columns.length;
            }
            if (col === undefined)
                col = index % columns.length;
            if (!columns[col])
                columns[col] = [];
            columns[col].push(item);
            prevCol = col;
            return columns;
        }, []);
    }
    computeColumnOffsets(items) {
        let prevOffset = 0;
        return items.reduce((offsets, item, index, list) => {
            const id = item.el.getAttribute('id');
            if (id === null)
                return offsets;
            if (index === 0) {
                offsets[id] = 0;
                return offsets;
            }
            const prevItem = list[index - 1];
            const y = prevItem.top + prevOffset + prevItem.height;
            offsets[id] = prevOffset = y - item.top;
            return offsets;
        }, {});
    }
}
function mapStateToProps(storeState, props) {
    const { rtmOwl: { viewport: { resizeInProgress } } } = storeState;
    return Object.assign({}, props, {
        viewportResizeInProgress: resizeInProgress
    });
}
exports.default = react_redux_1.connect(mapStateToProps)(CascadedColumnsList);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FzY2FkZWRDb2x1bW5zTGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL0Nhc2NhZGVkQ29sdW1uc0xpc3QudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esb0NBQW9DO0FBQ3BDLDBDQUEwQztBQUMxQywrQkFBOEI7QUFDOUIsNkNBQXFDO0FBcUNyQyx5QkFBMEIsU0FBUSxLQUFLLENBQUMsU0FBdUI7SUFPOUQsWUFBWSxLQUFLO1FBQ2hCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVaLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDWixPQUFPLEVBQUUsRUFBRTtTQUNYLENBQUE7UUFFRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDdEQsQ0FBQztJQUVELHlCQUF5QixDQUFDLEtBQVk7UUFDckMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDOUIsTUFBTSxDQUFDO1FBQ1IsQ0FBQztRQUVELE1BQU0sRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLEdBQUcsS0FBSyxDQUFBO1FBQ3hDLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1FBRS9CLE1BQU0sS0FBSyxHQUFHLENBQUMsS0FBWSxLQUFLLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFBO1FBRTlDLE1BQU0sR0FBRyxHQUFPLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUNuRCxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUE7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QUFDLENBQUE7Z0JBQ2YsTUFBTSxDQUFDLE9BQU8sQ0FBQztZQUNoQixDQUFDO1lBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBQyxDQUFDLENBQUMsQ0FBQTtZQUM5QixNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsR0FBRyxHQUFHLFVBQVUsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFBO1lBQ3JELE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUE7WUFFdkMsTUFBTSxDQUFDLE9BQU8sQ0FBQTtRQUNmLENBQUMsRUFBRSxFQUFnQixDQUFDLENBQUE7SUFDckIsQ0FBQztDQUVEO0FBR0QseUJBQXlCLFVBQXNCLEVBQUUsS0FBWTtJQUM1RCxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsUUFBUSxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxFQUFFLEdBQUcsVUFBVSxDQUFBO0lBRWpFLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUU7UUFDL0Isd0JBQXdCLEVBQUUsZ0JBQWdCO0tBQzFDLENBQUMsQ0FBQTtBQUNILENBQUM7QUFFRCxrQkFBZSxxQkFBTyxDQUNyQixlQUFlLENBQ2YsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgbGFzdCA9IHJlcXVpcmUoJ2xvZGFzaC9sYXN0JylcbmltcG9ydCBpc0VxdWFsID0gcmVxdWlyZSgnbG9kYXNoL2lzRXF1YWwnKVxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBjb25uZWN0IH0gZnJvbSAncmVhY3QtcmVkdXgnXG5cbmltcG9ydCB7IFN0b3JlU3RhdGUgfSBmcm9tICcuLi9zdG9yZSdcblxuXG5pbnRlcmZhY2UgQ2hpbGRQcm9wcyB7XG5cdGlkOiBzdHJpbmdcblx0c3R5bGU6IFJlYWN0LkNTU1Byb3BlcnRpZXNcbn1cblxudHlwZSBDaGlsZCA9IFJlYWN0LlJlYWN0RWxlbWVudDxDaGlsZFByb3BzPlxudHlwZSBPZmZzZXRMaXN0ID0geyBba2V5OiBzdHJpbmddOiBudW1iZXIgfVxuXG5pbnRlcmZhY2UgT3duUHJvcHMge1xuXHRjaGlsZHJlbjogQ2hpbGRbXVxufVxuXG5pbnRlcmZhY2UgU3RhdGVQcm9wcyB7XG5cdHZpZXdwb3J0UmVzaXplSW5Qcm9ncmVzczogYm9vbGVhblxufVxuXG5pbnRlcmZhY2UgRGlzcGF0Y2hQcm9wcyB7fVxuXG5cbnR5cGUgUHJvcHMgPSBPd25Qcm9wcyAmIFN0YXRlUHJvcHMgJiBEaXNwYXRjaFByb3BzXG5cbmludGVyZmFjZSBTdGF0ZSB7XG5cdG9mZnNldHM6IE9mZnNldExpc3Rcbn1cblxuaW50ZXJmYWNlIEl0ZW0ge1xuXHRlbDogRWxlbWVudFxuXHR0b3A6IG51bWJlclxuXHRoZWlnaHQ6IG51bWJlclxufVxuXG5cbmNsYXNzIENhc2NhZGVkQ29sdW1uc0xpc3QgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XG5cblx0cHJpdmF0ZSBlbDogSFRNTEVsZW1lbnR8bnVsbFxuXHRwcml2YXRlIG9mZnNldFBhcmVudFRvcDogbnVtYmVyXG5cdHByaXZhdGUgaW1hZ2VzOiBIVE1MSW1hZ2VFbGVtZW50W118dW5kZWZpbmVkXG5cdHByaXZhdGUgaW1hZ2VMb2FkSGFuZGxlcjogKCkgPT4gdm9pZFxuXG5cdGNvbnN0cnVjdG9yKHByb3BzKSB7XG5cdFx0c3VwZXIocHJvcHMpXG5cblx0XHR0aGlzLnN0YXRlID0ge1xuXHRcdFx0b2Zmc2V0czoge31cblx0XHR9XG5cblx0XHR0aGlzLmltYWdlTG9hZEhhbmRsZXIgPSB0aGlzLnVwZGF0ZU9mZnNldHMuYmluZCh0aGlzKVxuXHR9XG5cblx0Y29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhwcm9wczogUHJvcHMpIHtcblx0XHRpZiAocHJvcHMudmlld3BvcnRSZXNpemVJblByb2dyZXNzKSB7XG5cdFx0XHR0aGlzLnNldFN0YXRlKHsgb2Zmc2V0czoge30gfSlcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCB7IGNoaWxkcmVuOiBuZXh0Q2hpbGRyZW4gfSA9IHByb3BzXG5cdFx0Y29uc3QgeyBjaGlsZHJlbiB9ID0gdGhpcy5wcm9wc1xuXG5cdFx0Y29uc3QgZ2V0SUQgPSAoY2hpbGQ6IENoaWxkKSA9PiBjaGlsZC5wcm9wcy5pZFxuXG5cdFx0Y29uc3QgaWRzICAgICA9IFJlYWN0LkNoaWxkcmVuLm1hcChjaGlsZHJlbiwgZ2V0SUQpXG5cdFx0Y29uc3QgbmV4dElEcyA9IFJlYWN0LkNoaWxkcmVuLm1hcChuZXh0Q2hpbGRyZW4sIGdldElEKVxuXG5cdFx0aWYgKCFpc0VxdWFsKGlkcywgbmV4dElEcykpXG5cdFx0XHR0aGlzLnNldFN0YXRlKHsgb2Zmc2V0czoge30gfSlcblx0fVxuXG5cdGNvbXBvbmVudFdpbGxVcGRhdGUoKSB7XG5cdFx0dGhpcy51bnNldFVwZGF0ZU9uSW1hZ2VMb2FkTGlzdGVuZXJzKClcblx0fVxuXG5cdGNvbXBvbmVudERpZE1vdW50KCkge1xuXHRcdGlmICghdGhpcy5wcm9wcy52aWV3cG9ydFJlc2l6ZUluUHJvZ3Jlc3MpIHtcblx0XHRcdHRoaXMuc2V0VXBkYXRlT25JbWFnZUxvYWRMaXN0ZW5lcnMoKVxuXHRcdFx0dGhpcy51cGRhdGVPZmZzZXRzKClcblx0XHR9XG5cdH1cblxuXHRjb21wb25lbnREaWRVcGRhdGUoKSB7XG5cdFx0aWYgKCF0aGlzLnByb3BzLnZpZXdwb3J0UmVzaXplSW5Qcm9ncmVzcykge1xuXHRcdFx0dGhpcy5zZXRVcGRhdGVPbkltYWdlTG9hZExpc3RlbmVycygpXG5cdFx0XHRpZiAoT2JqZWN0LmtleXModGhpcy5zdGF0ZS5vZmZzZXRzKS5sZW5ndGggPT09IDApXG5cdFx0XHRcdHRoaXMudXBkYXRlT2Zmc2V0cygpXG5cdFx0fVxuXHR9XG5cblx0Y29tcG9uZW50V2lsbFVubW91bnQoKSB7XG5cdFx0dGhpcy51bnNldFVwZGF0ZU9uSW1hZ2VMb2FkTGlzdGVuZXJzKClcblx0fVxuXG5cdHJlbmRlcigpIHtcblx0XHRjb25zdCBjaGlsZHJlbiA9IFJlYWN0LkNoaWxkcmVuLm1hcCh0aGlzLnByb3BzLmNoaWxkcmVuLFxuXHRcdChjaGlsZDogQ2hpbGQpID0+IHtcblx0XHRcdGxldCBzdHlsZTogUmVhY3QuQ1NTUHJvcGVydGllcyA9IHt9XG5cblx0XHRcdGNvbnN0IG9mZnNldDogbnVtYmVyfHVuZGVmaW5lZCA9IHRoaXMuc3RhdGUub2Zmc2V0c1tjaGlsZC5wcm9wcy5pZF1cblx0XHRcdGlmIChvZmZzZXQgPT09IHVuZGVmaW5lZClcblx0XHRcdFx0cmV0dXJuIGNoaWxkXG5cblx0XHRcdHN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGVZKCR7b2Zmc2V0fXB4KWBcblx0XHRcdHJldHVybiBSZWFjdC5jbG9uZUVsZW1lbnQoY2hpbGQsIHsgc3R5bGUgfSlcblx0XHR9KVxuXG5cdFx0cmV0dXJuIChcblx0XHRcdDxkaXYgY2xhc3NOYW1lPVwiaXRlbXMgY2FzY2FkZWQtY29sdW1uLWxpc3RcIlxuXHRcdFx0ICAgICByZWY9e3JlZiA9PiB0aGlzLmVsID0gcmVmfT5cblx0XHRcdFx0e2NoaWxkcmVufVxuXHRcdFx0PC9kaXY+XG5cdFx0KVxuXHR9XG5cblx0cHJpdmF0ZSBzZXRVcGRhdGVPbkltYWdlTG9hZExpc3RlbmVycygpOiB2b2lkIHtcblx0XHRpZiAoIXRoaXMuZWwpXG5cdFx0XHRyZXR1cm47XG5cblx0XHR0aGlzLmltYWdlcyA9IFtdXG5cdFx0Y29uc3QgaW1hZ2VzID0gdGhpcy5lbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW1nJylcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGltYWdlcy5sZW5ndGg7IGkrKylcblx0XHRcdHRoaXMuaW1hZ2VzLnB1c2goaW1hZ2VzLml0ZW0oaSkpXG5cblx0XHR0aGlzLmltYWdlcy5mb3JFYWNoKGltZyA9PiB7XG5cdFx0XHRpbWcuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIHRoaXMuaW1hZ2VMb2FkSGFuZGxlcilcblx0XHR9KVxuXHR9XG5cblx0cHJpdmF0ZSB1bnNldFVwZGF0ZU9uSW1hZ2VMb2FkTGlzdGVuZXJzKCk6IHZvaWQge1xuXHRcdGlmICh0aGlzLmltYWdlcyA9PT0gdW5kZWZpbmVkKVxuXHRcdFx0cmV0dXJuO1xuXG5cdFx0dGhpcy5pbWFnZXMuZm9yRWFjaChpbWcgPT4ge1xuXHRcdFx0aW1nLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCB0aGlzLmltYWdlTG9hZEhhbmRsZXIpXG5cdFx0fSlcblx0fVxuXG5cdHByaXZhdGUgdXBkYXRlT2Zmc2V0cygpOiB2b2lkIHtcblx0XHRjb25zdCBvZmZzZXRzID0gdGhpcy5jb21wdXRlT2Zmc2V0cygpXG5cdFx0aWYgKCFpc0VxdWFsKG9mZnNldHMsIHRoaXMuc3RhdGUub2Zmc2V0cykpXG5cdFx0XHR0aGlzLnNldFN0YXRlKHsgb2Zmc2V0cyB9KVxuXHR9XG5cblx0cHJpdmF0ZSBjb21wdXRlT2Zmc2V0cygpOiBPZmZzZXRMaXN0IHtcblx0XHRpZiAoIXRoaXMuZWwpXG5cdFx0XHRyZXR1cm4ge307XG5cblx0XHRjb25zdCBlbGVtZW50cyA9IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCgnOnNjb3BlID4gKicpXG5cdFx0aWYgKGVsZW1lbnRzLmxlbmd0aCA9PT0gMClcblx0XHRcdHJldHVybiB7fTtcblxuXHRcdC8vIGB0aGlzLmVsZW1lbnRUb0l0ZW0oKWAgcmVxdWlyZXMgdGhpcyB0byBiZSBzZXQuXG5cdFx0dGhpcy5vZmZzZXRQYXJlbnRUb3AgPSBlbGVtZW50cy5pdGVtKDApLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcFxuXG5cdFx0Y29uc3QgaXRlbXM6IEl0ZW1bXSA9IFtdXG5cdFx0ZWxlbWVudHMuZm9yRWFjaChlbCA9PiB7XG5cdFx0XHRpdGVtcy5wdXNoKHRoaXMuZWxlbWVudFRvSXRlbShlbCBhcyBIVE1MRWxlbWVudCkpXG5cdFx0fSlcblxuXHRcdGNvbnN0IGNvbHVtbnMgPSB0aGlzLnNwbGl0SW50b0NvbHVtbnMoaXRlbXMpXG5cdFx0aWYgKGNvbHVtbnMubGVuZ3RoID09PSAxKVxuXHRcdFx0cmV0dXJuIHt9XG5cblx0XHRjb25zdCBvZmZzZXRzOiBPZmZzZXRMaXN0W10gPVxuXHRcdFx0Y29sdW1ucy5tYXAodGhpcy5jb21wdXRlQ29sdW1uT2Zmc2V0cy5iaW5kKHRoaXMpKVxuXG5cdFx0cmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIC4uLm9mZnNldHMpXG5cdH1cblxuXHRlbGVtZW50VG9JdGVtKGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogSXRlbSB7XG5cdFx0Y29uc3QgdG9wID0gdGhpcy5vZmZzZXRQYXJlbnRUb3AgKyBlbGVtZW50Lm9mZnNldFRvcFxuXHRcdFx0Ly8gR2V0IHRoZSB0cnVlIHRvcCBwb3NpdGlvbiByZWxhdGl2ZSB0byB0aGUgZG9jdW1lbnQgcm9vdCwgdW5hZmZlY3RlZCBieVxuXHRcdFx0Ly8gYW55IHRyYW5zZm9ybXMuXG5cdFx0Y29uc3Qgc3R5bGVzID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudClcblxuXHRcdGxldCB7IGhlaWdodCB9ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuXHRcdGhlaWdodCArPSAocGFyc2VJbnQoc3R5bGVzLm1hcmdpblRvcCAgICB8fCAnMCcsIDEwKSB8fCAwKVxuXHRcdCAgICAgICAgKyAocGFyc2VJbnQoc3R5bGVzLm1hcmdpbkJvdHRvbSB8fCAnMCcsIDEwKSB8fCAwKVxuXG5cdFx0cmV0dXJuIHsgZWw6IGVsZW1lbnQsIHRvcCwgaGVpZ2h0IH1cblx0fVxuXG5cdHNwbGl0SW50b0NvbHVtbnMoaXRlbXM6IEl0ZW1bXSk6IEl0ZW1bXVtdIHtcblx0XHRsZXQgcHJldkNvbDogbnVtYmVyXG5cblx0XHRyZXR1cm4gaXRlbXMucmVkdWNlKChjb2x1bW5zLCBpdGVtLCBpbmRleCkgPT4ge1xuXHRcdFx0bGV0IGNvbDogbnVtYmVyfHVuZGVmaW5lZFxuXG5cdFx0XHRpZiAoY29sdW1ucy5sZW5ndGggPT09IDApXG5cdFx0XHRcdGNvbCA9IDBcblx0XHRcdGVsc2UgaWYgKGNvbHVtbnMubGVuZ3RoID09PSBpbmRleCkge1xuXHRcdFx0XHQvLyBQb3RlbnRpYWxseSBuZWVkIHRvIGFkZCBhbm90aGVyIGNvbHVtbi5cblx0XHRcdFx0Y29uc3QgcHJldkl0ZW0gPSBsYXN0KGNvbHVtbnNbcHJldkNvbF0pIGFzIEl0ZW1cblx0XHRcdFx0aWYgKGl0ZW0udG9wID09PSBwcmV2SXRlbS50b3ApXG5cdFx0XHRcdFx0Y29sID0gY29sdW1ucy5sZW5ndGhcblx0XHRcdH1cblxuXHRcdFx0aWYgKGNvbCA9PT0gdW5kZWZpbmVkKVxuXHRcdFx0XHRjb2wgPSBpbmRleCAlIGNvbHVtbnMubGVuZ3RoXG5cblx0XHRcdGlmICghY29sdW1uc1tjb2xdKVxuXHRcdFx0XHRjb2x1bW5zW2NvbF0gPSBbXVxuXG5cdFx0XHRjb2x1bW5zW2NvbF0ucHVzaChpdGVtKVxuXHRcdFx0cHJldkNvbCA9IGNvbFxuXG5cdFx0XHRyZXR1cm4gY29sdW1uc1xuXHRcdH0sIFtdIGFzIEl0ZW1bXVtdKVxuXHR9XG5cblx0Y29tcHV0ZUNvbHVtbk9mZnNldHMoaXRlbXM6IEl0ZW1bXSk6IE9mZnNldExpc3Qge1xuXHRcdGxldCBwcmV2T2Zmc2V0ID0gMFxuXG5cdFx0cmV0dXJuIGl0ZW1zLnJlZHVjZSgob2Zmc2V0cywgaXRlbSwgaW5kZXgsIGxpc3QpID0+IHtcblx0XHRcdGNvbnN0IGlkID0gaXRlbS5lbC5nZXRBdHRyaWJ1dGUoJ2lkJylcblx0XHRcdGlmIChpZCA9PT0gbnVsbClcblx0XHRcdFx0cmV0dXJuIG9mZnNldHM7XG5cblx0XHRcdGlmIChpbmRleCA9PT0gMCkge1xuXHRcdFx0XHRvZmZzZXRzW2lkXSA9IDBcblx0XHRcdFx0cmV0dXJuIG9mZnNldHM7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IHByZXZJdGVtID0gbGlzdFtpbmRleC0xXVxuXHRcdFx0Y29uc3QgeSA9IHByZXZJdGVtLnRvcCArIHByZXZPZmZzZXQgKyBwcmV2SXRlbS5oZWlnaHRcblx0XHRcdG9mZnNldHNbaWRdID0gcHJldk9mZnNldCA9IHkgLSBpdGVtLnRvcFxuXG5cdFx0XHRyZXR1cm4gb2Zmc2V0c1xuXHRcdH0sIHt9IGFzIE9mZnNldExpc3QpXG5cdH1cblxufVxuXG5cbmZ1bmN0aW9uIG1hcFN0YXRlVG9Qcm9wcyhzdG9yZVN0YXRlOiBTdG9yZVN0YXRlLCBwcm9wczogUHJvcHMpOiBTdGF0ZVByb3BzIHtcblx0Y29uc3QgeyBydG1Pd2w6IHsgdmlld3BvcnQ6IHsgcmVzaXplSW5Qcm9ncmVzcyB9IH0gfSA9IHN0b3JlU3RhdGVcblxuXHRyZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgcHJvcHMsIHtcblx0XHR2aWV3cG9ydFJlc2l6ZUluUHJvZ3Jlc3M6IHJlc2l6ZUluUHJvZ3Jlc3Ncblx0fSlcbn1cblxuZXhwb3J0IGRlZmF1bHQgY29ubmVjdDxTdGF0ZVByb3BzLCBEaXNwYXRjaFByb3BzLCBPd25Qcm9wcz4oXG5cdG1hcFN0YXRlVG9Qcm9wc1xuKShDYXNjYWRlZENvbHVtbnNMaXN0KVxuIl19